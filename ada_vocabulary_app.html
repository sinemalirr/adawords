<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ada'nÄ±n BaÅŸarÄ± DÃ¼nyasÄ± (Vocabulary)</title>
    
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        :root {
            --primary: #FF6B6B; /* KÄ±rmÄ±zÄ±msÄ± Pembe */
            --secondary: #4ECDC4; /* Turkuaz */
            --accent: #FFE66D; /* SarÄ± */
            --dark: #2C3E50; /* Koyu Mavi */
        }
        
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }

        /* Mobil Cihaz GÃ¶rÃ¼nÃ¼mÃ¼ iÃ§in KÄ±sÄ±tlama */
        #app-container {
            max-width: 420px;
            height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* Flashcard Styling */
        .flashcard-container {
            perspective: 1000px;
            width: 90%;
            height: 250px;
        }
        .flashcard {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        .flashcard.flipped { transform: rotateY(180deg); }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--dark);
            border-radius: 15px;
            border: 3px solid var(--secondary);
            background-color: white;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
        }
        .card-back { transform: rotateY(180deg); background-color: #e0fffb; color: var(--primary); font-size: 1.5rem; }

        /* Button Animations */
        .btn-action {
            box-shadow: 0 4px 0 var(--dark);
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .btn-action:active {
            transform: translateY(2px);
            box-shadow: 2px 0 0 var(--dark);
        }
        
        /* Quiz Button Styling */
        .quiz-option-btn {
            box-shadow: 0 2px 0 #155e75; /* Teal shadow */
        }
        .quiz-option-btn:hover {
            background-color: #f0fdfa; /* Light teal on hover */
        }
        .quiz-option-btn:active {
            transform: translateY(1px);
            box-shadow: 0 1px 0 #155e75;
        }
    </style>
</head>
<body class="flex justify-center items-center h-screen">

<div id="app-container" class="bg-white flex flex-col">
    
    <header class="bg-gradient-to-br from-red-400 to-teal-400 text-white p-4 rounded-b-xl shadow-lg">
        <h1 class="text-2xl font-bold text-center">Ada'nÄ±n BaÅŸarÄ± DÃ¼nyasÄ± ğŸŒŸ</h1>
        <div class="flex justify-around items-center mt-2 text-sm font-semibold">
            <span>ğŸ”¥ Seri: <span id="streak-count">0</span> GÃ¼n</span>
            <span>â±ï¸ <span id="timer-display">00:00</span> / 15:00</span>
        </div>
        <p id="streak-goal-msg" class="text-center text-xs mt-1 italic opacity-90">10 gÃ¼n Ã¼st Ã¼ste seri yap, Ã¶dÃ¼l kazan!</p>
        <div class="w-full bg-white bg-opacity-30 rounded-full h-2 mt-2">
            <div id="progress-bar" class="bg-yellow-300 h-2 rounded-full transition-all duration-500" style="width: 0%;"></div>
        </div>
    </header>

    <div id="main-content" class="flex-1 p-5 overflow-y-auto">
        <div id="loading-screen" class="absolute inset-0 bg-white/80 flex items-center justify-center z-50">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-r-white border-teal-500 mx-auto"></div>
                <p class="mt-4 text-gray-700">BaÄŸlanÄ±lÄ±yor...</p>
            </div>
        </div>

        <div id="screen-home" class="screen flex flex-col items-center space-y-5">
            <div class="text-center my-8">
                <h3 class="text-3xl font-extrabold text-gray-800">HoÅŸgeldin Ada!</h3>
                <p id="completion-msg" class="text-green-600 font-bold mt-2 hidden">BUGÃœN TAMAMLANDI! âœ…</p>
                <p id="reward-notification" class="text-red-500 font-bold mt-2 text-lg animate-pulse hidden">ğŸ Ã–DÃœL KAZANDIN! TÄ±kla!</p>
            </div>

            <div id="account-link-form" class="w-11/12 bg-blue-100 p-4 rounded-xl space-y-3 shadow-inner">
                <h4 class="text-lg font-bold text-blue-700">KalÄ±cÄ± Hesap BaÄŸlama</h4>
                <p class="text-sm text-gray-600">Verilerini kaybetmemek ve her cihazda gÃ¶rmek iÃ§in anonim hesabÄ± e-posta ile baÄŸla.</p>
                
                <input type="email" id="emailInput" placeholder="KullanÄ±lacak E-posta" 
                       class="p-2 border rounded-lg w-full focus:ring-blue-500 focus:border-blue-500">
                <input type="password" id="passwordInput" placeholder="Yeni Åifre OluÅŸtur" 
                       class="p-2 border rounded-lg w-full focus:ring-blue-500 focus:border-blue-500">
                
                <button id="registerButton" 
                        class="w-full p-2 bg-blue-600 text-white font-semibold rounded-lg btn-action shadow-blue-800">
                    HesabÄ± E-posta ile BaÄŸla
                </button>
            </div>
            <button class="w-11/12 p-4 bg-teal-500 text-white font-bold rounded-xl btn-action shadow-teal-700" onclick="startStudy('flashcard')">
                ğŸƒ KARTLARLA Ã–ÄREN
            </button>
            <button class="w-11/12 p-4 bg-red-500 text-white font-bold rounded-xl btn-action shadow-red-700" onclick="startStudy('quiz')">
                âœï¸ Ã‡OKTAN SEÃ‡MELÄ° SINAV
            </button>
            <button class="w-11/12 p-4 bg-yellow-500 text-white font-bold rounded-xl btn-action shadow-yellow-700" onclick="startStudy('fillInTheBlanks')">
                âœï¸ BOÅLUK DOLDURMA SINAVI
            </button>
            <button class="w-11/12 p-4 bg-gray-600 text-white font-bold rounded-xl btn-action shadow-gray-800" onclick="showScreen('parent')">
                ğŸ”’ EBEVEYN KELÄ°ME YÃ–NETÄ°MÄ°
            </button>
        </div>
        <div id="screen-flashcard" class="screen hidden flex-col items-center">
            <button class="text-gray-500 mb-4 self-start" onclick="stopStudy()">
                <span class="text-2xl">â¬…ï¸</span> MenÃ¼ye DÃ¶n
            </button>
            <div class="flashcard-container mb-6" onclick="flipCard()">
                <div class="flashcard" id="active-card">
                    <div class="card-face card-front border-teal-500">YÃ¼kleniyor...</div>
                    <div class="card-face card-back border-red-500">Loading...</div>
                </div>
            </div>
            <div class="flex space-x-4">
                <button class="p-3 bg-red-400 text-white font-semibold rounded-full btn-action shadow-red-600" onclick="nextCard(false)">
                    ğŸ˜“ Unuttum
                </button>
                <button class="p-3 bg-teal-500 text-white font-semibold rounded-full btn-action shadow-teal-700" onclick="nextCard(true)">
                    ğŸ§  Biliyorum
                </button>
            </div>
        </div>

        <div id="screen-quiz" class="screen hidden flex-col items-center">
            <button class="text-gray-500 mb-4 self-start" onclick="stopStudy()">
                <span class="text-2xl">â¬…ï¸</span> MenÃ¼ye DÃ¶n
            </button>
            
            <h3 class="text-xl font-semibold mb-6 text-gray-700">AÅŸaÄŸÄ±daki kelimelerden doÄŸru olanÄ± seÃ§:</h3>
            
            <p class="text-3xl font-bold text-red-500 mb-8 text-center px-4" id="quiz-question-mc">YÃ¼kleniyor...</p>

            <div id="answer-options-mc" class="flex flex-col space-y-4 w-full max-w-sm">
                </div>
            
            <div id="quiz-feedback-mc" class="mt-6 h-6 font-bold text-center"></div>
        </div>

        <div id="screen-fillInTheBlanks" class="screen hidden flex-col items-center">
            <button class="text-gray-500 mb-4 self-start" onclick="stopStudy()">
                <span class="text-2xl">â¬…ï¸</span> MenÃ¼ye DÃ¶n
            </button>
            
            <h3 class="text-xl font-semibold mb-6 text-gray-700">LÃ¼tfen doÄŸru Ã§eviriyi yazÄ±n:</h3>
            
            <p class="text-3xl font-bold text-red-500 mb-8 text-center px-4" id="fitb-question">YÃ¼kleniyor...</p>

            <input type="text" id="fitb-input" placeholder="CevabÄ±nÄ±zÄ± buraya yazÄ±n..." class="p-3 border-2 border-teal-500 rounded-lg w-full max-w-sm text-center text-xl focus:border-red-500 transition duration-300">
            
            <button class="w-full max-w-sm p-3 mt-4 bg-teal-500 text-white font-bold rounded-lg btn-action shadow-teal-700" onclick="checkFillInTheBlanksAnswer()">
                CevabÄ± Kontrol Et
            </button>
            
            <div id="fitb-feedback" class="mt-6 h-6 font-bold text-center"></div>
        </div>


        <div id="screen-parent" class="screen hidden flex-col items-center">
            <button class="text-gray-500 mb-6 self-start" onclick="showScreen('home')">
                <span class="text-2xl">â¬…ï¸</span> MenÃ¼ye DÃ¶n
            </button>
            <h3 class="text-2xl font-bold mb-4 text-gray-800">ğŸ”’ Kelime YÃ¶netimi (Ebeveyne Ã–zel)</h3>
            <div class="w-full max-w-sm bg-gray-100 p-4 rounded-xl space-y-3 shadow-inner">
                <input type="text" id="new-eng" placeholder="Ä°ngilizce Kelime" class="p-2 border rounded-lg w-full">
                <input type="text" id="new-tr" placeholder="TÃ¼rkÃ§e AnlamÄ±" class="p-2 border rounded-lg w-full">
                <button class="w-full p-2 bg-gray-600 text-white font-semibold rounded-lg btn-action shadow-gray-800" onclick="addWord()">
                    + Yeni Kelime Ekle
                </button>
            </div>

            <h4 class="text-xl font-semibold mt-6 mb-2">Ekli Kelimeler (<span id="word-count">0</span>)</h4>
            <div class="w-full max-w-sm h-48 overflow-y-auto border rounded-lg p-2 bg-white shadow-md">
                <ul id="word-list-display">
                    </ul>
            </div>
            <p class="text-sm text-gray-500 mt-2">Bu ekranda harcanan sÃ¼re sayÄ±lmaz.</p>
        </div>

        <div id="screen-reward" class="screen hidden flex-col items-center justify-center h-full">
            <h2 class="text-3xl font-extrabold text-red-600 mb-4 animate-bounce">ğŸ‰ TEBRÄ°KLER ADA! ğŸ‰</h2>
            <p class="text-xl text-gray-700 mb-8">10 GÃ¼nlÃ¼k muhteÅŸem seriyi tamamladÄ±n!</p>
            <p class="text-2xl font-semibold text-teal-600 mb-6">Åimdi hediye paketini seÃ§:</p>
            <div class="flex space-x-6">
                <div class="text-6xl cursor-pointer hover:scale-110 transition-transform gift-box" data-gift="1" onclick="openGift(1)">ğŸ</div>
                <div class="text-6xl cursor-pointer hover:scale-110 transition-transform gift-box" data-gift="2" onclick="openGift(2)">ğŸ</div>
                <div class="text-6xl cursor-pointer hover:scale-110 transition-transform gift-box" data-gift="3" onclick="openGift(3)">ğŸ</div>
            </div>
            <div id="gift-reveal" class="mt-8 p-4 bg-yellow-100 text-gray-900 rounded-lg shadow-inner text-center text-xl font-bold transition-all duration-500 opacity-0">
                </div>
            <button id="claim-button" class="mt-10 p-4 bg-teal-500 text-white font-bold rounded-xl btn-action shadow-teal-700 hidden" onclick="claimReward()">
                Ã–dÃ¼lÃ¼ AldÄ±m, MenÃ¼ye DÃ¶n
            </button>
        </div>
    </div>
</div>

<div id="modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50">
    <div id="custom-modal" class="bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-sm text-center transform scale-90 transition-transform duration-300">
        <h3 id="modal-title" class="text-xl font-bold mb-3 text-red-500">Bildirim</h3>
        <p id="modal-message" class="text-gray-700 mb-5"></p>
        <button id="modal-ok-button" class="p-2 bg-teal-500 text-white rounded-lg w-full font-semibold" onclick="closeModal()">Tamam</button>
    </div>
</div>


<script type="module">
    // Firebase modÃ¼llerini iÃ§e aktarma
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, EmailAuthProvider, linkWithCredential, signInWithCredential } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, onSnapshot, updateDoc, getDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // --- 1. FIREBASE KONFÄ°GÃœRASYONU VE BAÅLATMA ---
    const firebaseConfig = {
        apiKey: "AIzaSyAp3ywA8mWCKOH3fA7JACPfx3Ko_7VaD00",
        authDomain: "ada-vocabulary-world.firebaseapp.com",
        projectId: "ada-vocabulary-world",
        storageBucket: "ada-vocabulary-world.firebasestorage.app",
        messagingSenderId: "358916729594",
        appId: "1:358916729594:web:a5da6a37d9bafbf9d47743"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    // --- TEMEL AYARLAR ---
    const TARGET_TIME = 15 * 60; // 15 dakika (saniye)
    const STREAK_GOAL = 10;
    const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-ada-voc-app-v1'; 

    let userId = null;
    let appData = null;
    let timerInterval = null;
    let isStudying = false;
    let words = []; // Kelime listesi
    let isAuthReady = false;

    // FITB iÃ§in deÄŸiÅŸkenler
    let currentStudyWord = null;
    let expectedAnswer = null; 

    // --- HESAP BAÄLAMA VE VERÄ° TAÅIMA FONKSÄ°YONLARI ---
    
    // Anonim verileri kalÄ±cÄ± hesaba taÅŸÄ±r
    async function migrateAnonymousDataToNewUser(oldUid, newUid) {
        console.log(`Veri taÅŸÄ±ma baÅŸlatÄ±ldÄ±: ${oldUid} -> ${newUid}`);
        
        // 1. Profil Verisini TaÅŸÄ± (Meta/Streak/Time)
        const oldMetaRef = doc(db, 'artifacts', APP_ID, 'users', oldUid, 'profile', 'meta');
        const newMetaRef = doc(db, 'artifacts', APP_ID, 'users', newUid, 'profile', 'meta');
        
        const oldMetaSnapshot = await getDoc(oldMetaRef); 
        if (oldMetaSnapshot.exists()) {
            const oldData = oldMetaSnapshot.data();
            // Yeni kullanÄ±cÄ±ya yaz (mevcut verilerle birleÅŸtir)
            await setDoc(newMetaRef, oldData, { merge: true });
            // Eski veriyi sil
            await deleteDoc(oldMetaRef); 
        }
        
        // 2. Kelime Verilerini TaÅŸÄ± (Words Collection)
        const oldWordsCollectionRef = collection(db, 'artifacts', APP_ID, 'users', oldUid, 'words');
        const newWordsCollectionRef = collection(db, 'artifacts', APP_ID, 'users', newUid, 'words');

        const oldWordsSnapshot = await getDocs(oldWordsCollectionRef);
        
        // Her kelimeyi yeni koleksiyona kopyala (yeni belge ID'si ile) ve eskisini sil
        for (const docSnapshot of oldWordsSnapshot.docs) {
            await setDoc(doc(newWordsCollectionRef), docSnapshot.data());
            await deleteDoc(docSnapshot.ref); 
        }

        console.log("Veri taÅŸÄ±ma baÅŸarÄ±lÄ±.");
    }


    async function saveAccountWithEmail(email, password) {
        // Temel doÄŸrulama
        if (!email || !password) {
            showModal("UyarÄ±", "LÃ¼tfen e-posta ve ÅŸifre alanlarÄ±nÄ± boÅŸ bÄ±rakmayÄ±n.");
            return;
        }
        
        if (password.length < 6) {
             showModal("Hata", "Åifre en az 6 karakter olmalÄ±dÄ±r.");
             return;
        }

        const anonUser = auth.currentUser;
        if (!anonUser) {
             showModal("Hata", "Oturum aÃ§Ä±k deÄŸil. LÃ¼tfen uygulamayÄ± yenileyin.");
             return;
        }
        
        const oldUid = anonUser.uid; // Anonim kullanÄ±cÄ±nÄ±n ID'si

        try {
            // Anonim hesabÄ± e-posta/ÅŸifre ile baÄŸlamayÄ± dene (Yeni kalÄ±cÄ± hesap oluÅŸturma)
            const credential = EmailAuthProvider.credential(email, password);
            await linkWithCredential(anonUser, credential);
            
            showModal("BaÅŸarÄ±lÄ±", "HesabÄ±n baÅŸarÄ±yla e-posta ve ÅŸifre ile kalÄ±cÄ± olarak baÄŸlandÄ±!");
            
            // BAÄLANTI BAÅARILI: Formu gizle
            document.getElementById('account-link-form').classList.add('hidden');

        } catch (error) {
            console.error("Hesap baÄŸlama/birleÅŸtirme hatasÄ±:", error.code, error.message);
            
            if (error.code === 'auth/email-already-in-use' || error.code === 'auth/credential-already-in-use') {
                
                showModal("UyarÄ±", "Bu e-posta zaten kullanÄ±lÄ±yor. Mevcut anonim verilerinizi bu hesaba birleÅŸtirmek ister misiniz? Åifrenizi doÄŸru girdiÄŸinizden emin olun.");
                
                try {
                    // 1. Mevcut e-posta/ÅŸifre ile giriÅŸ yapma (Anonim oturumu kapatÄ±p kalÄ±cÄ±ya geÃ§me)
                    const credential = EmailAuthProvider.credential(email, password);
                    // Bu iÅŸlem, anonim oturumu sonlandÄ±rÄ±r ve kalÄ±cÄ± oturumu baÅŸlatÄ±r.
                    const userCredential = await signInWithCredential(auth, credential); 
                    const newUid = userCredential.user.uid; 
                    
                    // 2. Veri taÅŸÄ±ma iÅŸlemi
                    showModal("Veri TaÅŸÄ±ma", "Mevcut anonim verilerin kalÄ±cÄ± hesabÄ±na aktarÄ±lÄ±yor... LÃ¼tfen bekleyin.");
                    await migrateAnonymousDataToNewUser(oldUid, newUid); 
                    
                    // 3. BaÅŸarÄ±lÄ± mesajÄ±
                    showModal("BaÅŸarÄ±lÄ±", "HesabÄ±n baÅŸarÄ±yla birleÅŸtirildi ve verilerin aktarÄ±ldÄ±!");
                    
                    // Formu gizle
                    document.getElementById('account-link-form').classList.add('hidden');
                    
                } catch (mergeError) {
                    console.error("BirleÅŸtirme sÄ±rasÄ±nda hata:", mergeError.code, mergeError.message);
                    if (mergeError.code === 'auth/wrong-password' || mergeError.code === 'auth/invalid-credential') {
                        showModal("Hata", "GirdiÄŸin ÅŸifre, bu e-posta adresiyle eÅŸleÅŸmiyor. LÃ¼tfen kontrol et.");
                    } else {
                         showModal("Kritik Hata", `Hesap birleÅŸtirme baÅŸarÄ±sÄ±z oldu. Hata Kodu: ${mergeError.code}`);
                    }
                }
                
            } else if (error.code === 'auth/provider-already-linked') {
                showModal("UyarÄ±", "HesabÄ±n zaten e-posta/ÅŸifre ile kalÄ±cÄ± olarak baÄŸlanmÄ±ÅŸ.");
                document.getElementById('account-link-form').classList.add('hidden');
            } else if (error.code === 'auth/weak-password') {
                 showModal("Hata", "Åifre Ã§ok zayÄ±f. LÃ¼tfen en az 6 karakter uzunluÄŸunda bir ÅŸifre seÃ§in.");
            } else if (error.code === 'auth/invalid-email') {
                 showModal("Hata", "GeÃ§ersiz e-posta formatÄ±. LÃ¼tfen kontrol edin.");
            } else {
                 showModal("Hata", `Hesap baÄŸlama sÄ±rasÄ±nda beklenmeyen bir sorun oluÅŸtu. Hata Kodu: ${error.code}`);
            }
        }
    }

    // --- 2. FIREBASE VE AUTHENTICATION ---

    const getUserDataRef = () => doc(db, 'artifacts', APP_ID, 'users', userId, 'profile', 'meta');
    const getWordsRef = () => collection(db, 'artifacts', APP_ID, 'users', userId, 'words');

    async function setupDataListeners() {
        if (!isAuthReady) return;

        // 1. Profil ve Seri Takibi Verilerini Dinleme
        onSnapshot(getUserDataRef(), (docSnapshot) => {
            
            const todayStr = new Date().toDateString(); // KRÄ°TÄ°K DÃœZELTME: BugÃ¼nÃ¼n tarihini burada tanÄ±mla
            
            if (docSnapshot.exists()) {
                appData = docSnapshot.data();
            } else {
                // EÄŸer dokÃ¼man hiÃ§ yoksa, ilk defa oluÅŸturuluyor demektir.
                appData = {
                    streak: 0,
                    todayTime: 0,
                    dayCompleted: false,
                    lastActiveDate: todayStr, // KRÄ°TÄ°K DÃœZELTME: Ä°lk giriÅŸte bugÃ¼nÃ¼n tarihini kaydet
                    lastCompletedDate: null,
                    rewardClaimed: true 
                };
                setDoc(getUserDataRef(), appData);
            }
            
            checkDayReset();
            updateUI(); // Veri yÃ¼klendiÄŸinde UI'yÄ± gÃ¼ncelle
        });

        // 2. Kelimeleri Dinleme
        onSnapshot(getWordsRef(), (snapshot) => {
            words = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            updateWordListUI();
        });
    }

    function checkDayReset() {
        if (!appData) return;
        const todayStr = new Date().toDateString();
        
        if (appData.lastActiveDate !== todayStr) {
            appData.todayTime = 0;
            appData.dayCompleted = false;
            appData.lastActiveDate = todayStr;
            
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toDateString();

            if (appData.lastCompletedDate !== null && appData.lastCompletedDate !== yesterdayStr) {
                 appData.streak = 0;
            }
            
            updateDoc(getUserDataRef(), {
                todayTime: appData.todayTime,
                dayCompleted: appData.dayCompleted,
                lastActiveDate: appData.lastActiveDate,
                streak: appData.streak
            });
        }
    }

    // --- 3. AKILLI ZAMANLAYICI MANTIÄI ---

    function startTimer() {
        if (appData.dayCompleted) {
             document.getElementById('completion-msg').classList.remove('hidden');
             return;
        }

        // KRÄ°TÄ°K DÃœZELTME: UI'Ä± tekrar gÃ¼ncelleyerek todayTime'Ä±n Firebase'den yÃ¼klenen son deÄŸer olduÄŸundan emin ol.
        updateUI(); 
        
        isStudying = true;
        
        if (timerInterval) clearInterval(timerInterval);
        
        // KayÄ±t sayacÄ±, her 10 saniyede bir kaydetmek iÃ§in ayarlandÄ±.
        let saveCounter = 0; 
        
        timerInterval = setInterval(() => {
            if (!isStudying) return; 
            
            appData.todayTime++;
            updateUI();
            
            // HER 10 SANÄ°YEDE VERÄ°TABANINA KAYDETME MANTIÄI
            saveCounter++;
            if (saveCounter >= 10) { 
                updateDoc(getUserDataRef(), {
                    todayTime: appData.todayTime // Sadece sÃ¼reyi gÃ¼nceller
                }).then(() => {
                    console.log(`[Timer] SÃ¼re baÅŸarÄ±yla kaydedildi: ${appData.todayTime}s`);
                }).catch(e => {
                    console.error("[Timer] SÃ¼re kaydetme hatasÄ±:", e);
                });
                saveCounter = 0; // SayacÄ± sÄ±fÄ±rla
            }
            // --- KAYIT SONU ---
            
            if (appData.todayTime >= TARGET_TIME && !appData.dayCompleted) {
                completeDay();
            }
        }, 1000);
    }

    function stopTimer() {
        isStudying = false;
        if (timerInterval) clearInterval(timerInterval);
    }

    async function completeDay() {
        appData.dayCompleted = true;
        appData.streak++;
        appData.lastCompletedDate = new Date().toDateString();
        
        showModal("Tebrikler!", "BugÃ¼nkÃ¼ 15 dakikalÄ±k hedefini tamamladÄ±n! Seriye 1 gÃ¼n eklendi.");
        
        await updateDoc(getUserDataRef(), {
            dayCompleted: true,
            streak: appData.streak,
            lastCompletedDate: appData.lastCompletedDate
        });
        
        checkRewardStatus();
        stopTimer();
    }

    // --- 4. Ã–DÃœL VE SERÄ° TAKÄ°BÄ° ---
    
    function checkRewardStatus() {
        const rewardNotif = document.getElementById('reward-notification');
        
        if (appData && appData.streak > 0 && appData.streak % STREAK_GOAL === 0 && appData.rewardClaimed === true) {
             appData.rewardClaimed = false;
             updateDoc(getUserDataRef(), { rewardClaimed: false });
        }
        
        if (appData && appData.rewardClaimed === false) {
            rewardNotif.classList.remove('hidden');
            rewardNotif.onclick = () => showScreen('reward');
        } else {
            rewardNotif.classList.add('hidden');
            rewardNotif.onclick = null;
        }
    }

    const REWARD_OPTIONS = {
        1: "ğŸ” BÃ¼yÃ¼k Boy Hamburger MenÃ¼sÃ¼!",
        2: "ğŸ• Aile Boyu Pizza Ismarlama HakkÄ±!",
        3: "ğŸ’° 300 TL HarÃ§lÄ±k Kazanma HakkÄ±!",
        4: "ğŸ‰ SÃ¼rpriz Ã–dÃ¼l!" 
    };

    window.openGift = function(boxNum) {
        if (appData.rewardClaimed) {
            showModal("Hata", "Åu an aktif bir Ã¶dÃ¼l hakkÄ±n yok. Yeni seri iÃ§in Ã§alÄ±ÅŸmaya devam!");
            return;
        }
        
        const reveal = document.getElementById('gift-reveal');
        
        const rewardText = REWARD_OPTIONS[boxNum] || REWARD_OPTIONS[4]; 
        
        reveal.innerText = rewardText;
        reveal.classList.remove('opacity-0');
        reveal.classList.add('bg-yellow-300', 'shadow-2xl');
        
        document.querySelectorAll('.gift-box').forEach(box => {
            if (parseInt(box.dataset.gift) !== boxNum) {
                box.style.opacity = '0.3';
            } else {
                box.classList.remove('animate-bounce');
            }
            box.onclick = null; // TÃ¼m kutularÄ± tÄ±klanamaz yap
        });
        document.getElementById('claim-button').classList.remove('hidden');
    }

    window.claimReward = function() {
        if (appData.rewardClaimed === false) {
             updateDoc(getUserDataRef(), { rewardClaimed: true });
        }
        document.getElementById('gift-reveal').classList.add('opacity-0');
        document.getElementById('claim-button').classList.add('hidden');
        
        // KutularÄ± tekrar tÄ±klanabilir yap
        document.querySelectorAll('.gift-box').forEach(box => {
            box.onclick = () => openGift(parseInt(box.dataset.gift));
            box.style.opacity = '1.0';
        });
        
        showScreen('home');
    }

    // --- 5. KELÄ°ME YÃ–NETÄ°MÄ° (EBEVEYN) ---

    window.addWord = async function() {
        const en = document.getElementById('new-eng').value.trim();
        const tr = document.getElementById('new-tr').value.trim();
        
        if (!en || !tr) {
            showModal("UyarÄ±", "LÃ¼tfen hem Ä°ngilizce kelimeyi hem de TÃ¼rkÃ§e anlamÄ±nÄ± girin.");
            return;
        }

        try {
            await setDoc(doc(getWordsRef()), { 
                en: en, 
                tr: tr, 
                createdAt: new Date() 
            });
            document.getElementById('new-eng').value = "";
            document.getElementById('new-tr').value = "";
            showModal("BaÅŸarÄ±lÄ±", `Kelime: "${en}" baÅŸarÄ±yla eklendi!`);
        } catch (error) {
            console.error("Kelime eklenirken hata:", error);
            showModal("Hata", "Kelime eklenirken bir sorun oluÅŸtu.");
        }
    }

    function updateWordListUI() {
        const list = document.getElementById('word-list-display');
        const count = document.getElementById('word-count');
        list.innerHTML = "";
        count.innerText = words.length;

        if (words.length === 0) {
            list.innerHTML = `<li class="p-2 text-center text-gray-400">HenÃ¼z kelime yok. LÃ¼tfen yukarÄ±dan ekleyin.</li>`;
            return;
        }

        words.forEach(w => {
            const li = document.createElement('li');
            li.className = 'flex justify-between items-center p-2 border-b last:border-b-0 text-gray-700 text-sm';
            li.innerHTML = `<span><strong class="text-teal-600">${w.en}</strong> - ${w.tr}</span>`;
            list.appendChild(li);
        });
    }
    
    // --- 6. Ã–ÄRENME MODÃœLLERÄ° ---

    window.startStudy = function(mode) {
        if (words.length === 0) { 
            showModal("UyarÄ±", "LÃ¼tfen Ã¶nce kelime ekleyin.");
            return;
        }
        
        isStudying = true;
        startTimer();
        
        if (mode === 'flashcard') {
            showScreen('flashcard');
            loadFlashcard();
        } else if (mode === 'quiz') {
            if (words.length < 3) {
                showModal("UyarÄ±", "Ã‡oktan SeÃ§meli Quiz iÃ§in en az 3 kelime eklemelisin!");
                isStudying = false; stopTimer(); return;
            }
            showScreen('quiz');
            loadQuiz();
        } else if (mode === 'fillInTheBlanks') {
            showScreen('fillInTheBlanks');
            loadFillInTheBlanks();
        }
    }

    window.stopStudy = function() {
        isStudying = false;
        stopTimer();
        showScreen('home');
    }

    // FLASHCARD MANTIÄI (Kesintisiz AkÄ±ÅŸ)
    function loadFlashcard() {
        // Yeni bir kelime seÃ§
        currentStudyWord = words[Math.floor(Math.random() * words.length)];
        
        const card = document.getElementById('active-card');
        
        // KartÄ± geri dÃ¶ndÃ¼rerek Ä°ngilizce yÃ¼zÃ¼yle baÅŸlamasÄ±nÄ± saÄŸla
        card.classList.remove('flipped');
        
        // KartÄ±n dÃ¶nme animasyonu tamamlandÄ±ktan sonra yeni kelimeyi yÃ¼kle
        setTimeout(() => {
            document.querySelector('#active-card .card-front').innerText = currentStudyWord.en;
            document.querySelector('#active-card .card-back').innerText = currentStudyWord.tr;
        }, 300); 
    }

    window.flipCard = function() {
        document.getElementById('active-card').classList.toggle('flipped');
    }

    window.nextCard = function(known) {
        loadFlashcard();
    }

    // QUIZ MANTIÄI (Ã‡oktan SeÃ§meli)
    
    function getShuffledOptions(correctWord, allWords) {
        const decoys = allWords.filter(w => w.en !== correctWord.en);
        const shuffledDecoys = decoys.sort(() => 0.5 - Math.random());
        const incorrectOptions = shuffledDecoys.slice(0, Math.min(2, decoys.length)).map(w => ({ en: w.en, isCorrect: false }));
        
        const correctOption = { en: correctWord.en, isCorrect: true };
        let options = [...incorrectOptions, correctOption];
        
        return options.sort(() => 0.5 - Math.random());
    }

    window.loadQuiz = function() {
        if (words.length < 3) {
            document.getElementById('quiz-question-mc').innerText = "Quiz iÃ§in en az 3 farklÄ± kelime ekleyin!";
            document.getElementById('answer-options-mc').innerHTML = "";
            return;
        }

        currentStudyWord = words[Math.floor(Math.random() * words.length)];
        
        document.getElementById('quiz-question-mc').innerText = currentStudyWord.tr;
        const optionsContainer = document.getElementById('answer-options-mc');
        optionsContainer.innerHTML = "";
        document.getElementById('quiz-feedback-mc').innerText = "";

        const options = getShuffledOptions(currentStudyWord, words);
        
        options.forEach(option => {
            const button = document.createElement('button');
            button.className = 'w-full p-3 bg-white text-gray-800 font-semibold rounded-lg border-2 border-teal-500 hover:bg-teal-100 transition duration-150 shadow-md quiz-option-btn';
            button.innerText = option.en;
            button.dataset.isCorrect = option.isCorrect;
            button.onclick = () => checkAnswer(button);
            optionsContainer.appendChild(button);
        });
    }

    window.checkAnswer = function(selectedButton) {
        const optionsContainer = document.getElementById('answer-options-mc');
        const feedback = document.getElementById('quiz-feedback-mc');
        
        Array.from(optionsContainer.children).forEach(btn => btn.onclick = null);

        if (selectedButton.dataset.isCorrect === 'true') {
            selectedButton.classList.remove('bg-white', 'border-teal-500', 'hover:bg-teal-100');
            selectedButton.classList.add('bg-green-500', 'text-white', 'border-green-700');
            feedback.innerText = "ğŸ‰ DoÄŸru Cevap!";
            feedback.className = "mt-6 h-6 font-bold text-green-600";
        } else {
            selectedButton.classList.remove('bg-white', 'border-teal-500', 'hover:bg-teal-100');
            selectedButton.classList.add('bg-red-500', 'text-white', 'border-red-700');
            feedback.innerText = "âŒ YanlÄ±ÅŸ Cevap.";
            feedback.className = "mt-6 h-6 font-bold text-red-600";
            
            const correctButton = Array.from(optionsContainer.children).find(btn => btn.dataset.isCorrect === 'true');
            if (correctButton) {
                 correctButton.classList.remove('bg-white', 'border-teal-500', 'shadow-md', 'quiz-option-btn');
                 correctButton.classList.add('bg-green-200', 'border-green-500', 'text-gray-800', 'shadow-lg');
            }
        }
        
        setTimeout(() => {
            loadQuiz();
        }, 1500);
    }

    // QUIZ MANTIÄI (BoÅŸluk Doldurma)

    window.loadFillInTheBlanks = function() {
        currentStudyWord = words[Math.floor(Math.random() * words.length)];
        
        const isEnToTr = Math.random() < 0.5; 
        
        const questionText = document.getElementById('fitb-question');
        const inputField = document.getElementById('fitb-input');
        const feedback = document.getElementById('fitb-feedback');
        const checkButton = document.querySelector('#screen-fillInTheBlanks button[onclick="checkFillInTheBlanksAnswer()"]');
        
        inputField.value = "";
        feedback.innerText = "";
        inputField.disabled = false;
        checkButton.disabled = false;
        
        if (isEnToTr) {
            questionText.innerText = `"${currentStudyWord.en}" kelimesinin TÃ¼rkÃ§e karÅŸÄ±lÄ±ÄŸÄ± nedir?`;
            expectedAnswer = currentStudyWord.tr;
            inputField.placeholder = "TÃ¼rkÃ§e AnlamÄ±...";
        } else {
            questionText.innerText = `"${currentStudyWord.tr}" kelimesinin Ä°ngilizce karÅŸÄ±lÄ±ÄŸÄ± nedir?`;
            expectedAnswer = currentStudyWord.en;
            inputField.placeholder = "English Word...";
        }
        
        inputField.focus();
    }

    window.checkFillInTheBlanksAnswer = function() {
        const userInput = document.getElementById('fitb-input').value.trim().toLowerCase();
        const feedback = document.getElementById('fitb-feedback');
        const inputField = document.getElementById('fitb-input');
        const checkButton = document.querySelector('#screen-fillInTheBlanks button[onclick="checkFillInTheBlanksAnswer()"]');
        
        const expected = expectedAnswer.toLowerCase();
        
        const isCorrect = userInput === expected; 

        inputField.disabled = true;
        checkButton.disabled = true;
        
        if (isCorrect) {
            feedback.innerText = "ğŸ‰ DoÄŸru! HarikasÄ±n.";
            feedback.className = "mt-6 h-6 font-bold text-green-600";
            inputField.classList.add('bg-green-100');
        } else {
            feedback.innerText = `âŒ YanlÄ±ÅŸ. DoÄŸru cevap: "${expectedAnswer}"`;
            feedback.className = "mt-6 h-6 font-bold text-red-600";
            inputField.classList.add('bg-red-100');
        }
        
        setTimeout(() => {
            inputField.classList.remove('bg-green-100', 'bg-red-100');
            loadFillInTheBlanks();
        }, 2000);
    }


    // --- 7. UI GÃœNCELLEME VE GENEL FONKSÄ°YONLAR ---

    function updateUI() {
        if (!appData) return;

        // SÃ¼re ve Progress Bar
        const mins = Math.floor(appData.todayTime / 60);
        const secs = appData.todayTime % 60;
        document.getElementById('timer-display').innerText = 
            `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        
        const percent = Math.min((appData.todayTime / TARGET_TIME) * 100, 100);
        document.getElementById('progress-bar').style.width = percent + "%";

        // Seri
        document.getElementById('streak-count').innerText = appData.streak;
        
        // GÃ¼n tamamlandÄ± mesajÄ±
        const completionMsg = document.getElementById('completion-msg');
        if (appData.dayCompleted) {
            completionMsg.classList.remove('hidden');
        } else {
            completionMsg.classList.add('hidden');
        }
        
        // Ã–dÃ¼l durumu kontrolÃ¼
        checkRewardStatus();
    }
    
    window.showScreen = function(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        const targetScreen = document.getElementById('screen-' + screenId);
        
        // Hata kontrolÃ¼
        if (!targetScreen) {
             console.error(`Hata: 'screen-${screenId}' ID'li ekran bulunamadÄ±.`);
             showModal("Kritik Hata", "Uygulama ekranlarÄ±ndan biri yÃ¼klenemedi.");
             return;
        }
        
        targetScreen.classList.remove('hidden');
        
        if (screenId === 'home' || screenId === 'parent' || screenId === 'reward') {
            stopTimer();
            if (screenId === 'reward') {
                document.getElementById('gift-reveal').classList.add('opacity-0');
                document.getElementById('claim-button').classList.add('hidden');
            }
        }
    }

    window.showModal = function(title, message) {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-message').innerText = message;
        document.getElementById('modal-backdrop').classList.remove('hidden');
        document.getElementById('custom-modal').classList.add('scale-100');
    }

    window.closeModal = function() {
        document.getElementById('custom-modal').classList.remove('scale-100');
        document.getElementById('modal-backdrop').classList.add('hidden');
    }

    // --- UYGULAMA BAÅLATMA ve AUTHENTICATION YÃ–NETÄ°MÄ° ---

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // Oturum varsa (anonim veya kalÄ±cÄ±), User ID'yi kullan
            userId = user.uid;
            isAuthReady = true;

            // EÄŸer kullanÄ±cÄ±nÄ±n bir e-posta adresi varsa (yani kalÄ±cÄ± hesap) formu gizle
            const form = document.getElementById('account-link-form');
            if (form && user.email) {
                form.classList.add('hidden');
            }

            setupDataListeners();
        } else {
            // Oturum yoksa, anonim olarak giriÅŸ yap
            try {
                const anonUserCredential = await signInAnonymously(auth);
                userId = anonUserCredential.user.uid;
            } catch(error) {
                 showModal("Hata", "Anonim oturum baÅŸlatÄ±lamadÄ±.");
                 return;
            }
            isAuthReady = true;
            setupDataListeners();
        }
        
        // YÃ¼kleme ekranÄ±nÄ± gizleme
        document.getElementById('loading-screen').classList.add('hidden');
    });

    // DOMContentLoaded dinleyicisi
    document.addEventListener('DOMContentLoaded', () => {
        
        const registerButton = document.getElementById('registerButton');

        if (registerButton) {
            registerButton.addEventListener('click', () => {
                const email = document.getElementById('emailInput').value;
                const password = document.getElementById('passwordInput').value;
                
                saveAccountWithEmail(email, password); 
            });
        }
    });
        
</script>
</body>
</html>
