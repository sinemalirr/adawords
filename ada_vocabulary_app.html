import React, { useState, useEffect } from "react";
import { initializeApp } from "firebase/app";
import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  updateDoc,
  arrayUnion,
} from "firebase/firestore";

// Firebase config
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

function App() {
  const [userId, setUserId] = useState(null);
  const [words, setWords] = useState([]);
  const [newWord, setNewWord] = useState("");
  const [newMeaning, setNewMeaning] = useState("");
  const [quizAnswers, setQuizAnswers] = useState({});
  const [fillAnswers, setFillAnswers] = useState({});
  const [dailyMinutes, setDailyMinutes] = useState(0);
  const [progress, setProgress] = useState([]);
  const [startTime, setStartTime] = useState(null);

  // Anonim kullanÄ±cÄ± oluÅŸtur
  useEffect(() => {
    let anonId = localStorage.getItem("anonUserId");
    if (!anonId) {
      anonId = "user_" + Math.random().toString(36).substring(2, 15);
      localStorage.setItem("anonUserId", anonId);
    }
    setUserId(anonId);
    loadWords();
    loadProgress(anonId);
    setStartTime(Date.now());
  }, []);

  // Sayfa kapandÄ±ÄŸÄ±nda sÃ¼reyi kaydet
  useEffect(() => {
    const interval = setInterval(() => {
      if (startTime) {
        const diff = Math.floor((Date.now() - startTime) / 1000 / 60); // dakika
        setDailyMinutes(diff);
      }
    }, 10000); // her 10 saniyede bir gÃ¼ncelle
    return () => clearInterval(interval);
  }, [startTime]);

  useEffect(() => {
    if (dailyMinutes >= 15) updateDailyProgress();
  }, [dailyMinutes]);

  const loadWords = async () => {
    const docRef = doc(db, "users", "globalWords");
    const docSnap = await getDoc(docRef);
    if (docSnap.exists()) setWords(docSnap.data().words);
  };

  const loadProgress = async (anonId) => {
    const docRef = doc(db, "users", anonId);
    const docSnap = await getDoc(docRef);
    if (docSnap.exists()) {
      setProgress(docSnap.data().dailyProgress || []);
    } else {
      await setDoc(docRef, { dailyProgress: [], startDate: new Date().toISOString() });
      setProgress([]);
    }
  };

  const addWord = async () => {
    if (!newWord || !newMeaning) return;
    const newEntry = { id: Date.now(), word: newWord, meaning: newMeaning };
    const updatedWords = [...words, newEntry];
    setWords(updatedWords);
    setNewWord("");
    setNewMeaning("");
    const docRef = doc(db, "users", "globalWords");
    await setDoc(docRef, { words: updatedWords });
  };

  const updateDailyProgress = async () => {
    if (!userId) return;
    const today = new Date().toISOString().split("T")[0];
    if (progress.some((p) => p.date === today)) return;

    const newProgress = [...progress, { date: today, completed: true }];
    setProgress(newProgress);
    const docRef = doc(db, "users", userId);
    await updateDoc(docRef, { dailyProgress: newProgress });
  };

  const handleQuizChange = (id, value) => {
    setQuizAnswers({ ...quizAnswers, [id]: value });
  };

  const handleFillChange = (id, value) => {
    setFillAnswers({ ...fillAnswers, [id]: value });
  };

  const gifts = progress.length >= 10 ? ["ğŸ", "ğŸ‰", "ğŸ†"] : [];

  return (
    <div style={{ padding: "20px", fontFamily: "Arial" }}>
      <h1>English Learning App</h1>

      {/* Kelime GiriÅŸi */}
      <section>
        <h2>Add a new word</h2>
        <input
          type="text"
          placeholder="Word"
          value={newWord}
          onChange={(e) => setNewWord(e.target.value)}
        />
        <input
          type="text"
          placeholder="Meaning"
          value={newMeaning}
          onChange={(e) => setNewMeaning(e.target.value)}
        />
        <button onClick={addWord}>Add Word</button>
      </section>

      {/* Flashcards */}
      <section>
        <h2>Flashcards</h2>
        {words.map((w) => (
          <div key={w.id}>
            <strong>{w.word}</strong> - {w.meaning}
          </div>
        ))}
      </section>

      {/* Quiz */}
      <section>
        <h2>Quiz</h2>
        {words.map((w) => {
          const options = [w.meaning, "Wrong1", "Wrong2"].sort(() => Math.random() - 0.5);
          return (
            <div key={w.id}>
              <p>What is "{w.word}" in Turkish?</p>
              {options.map((opt) => (
                <label key={opt} style={{ marginRight: "10px" }}>
                  <input
                    type="radio"
                    name={`quiz_${w.id}`}
                    value={opt}
                    checked={quizAnswers[w.id] === opt}
                    onChange={(e) => handleQuizChange(w.id, e.target.value)}
                  />
                  {opt}
                </label>
              ))}
            </div>
          );
        })}
      </section>

      {/* Fill in the blanks */}
      <section>
        <h2>Fill in the blanks</h2>
        {words.map((w) => (
          <div key={w.id}>
            <p>I have an ___ ({w.word}).</p>
            <input
              type="text"
              value={fillAnswers[w.id] || ""}
              onChange={(e) => handleFillChange(w.id, e.target.value)}
            />
          </div>
        ))}
      </section>

      {/* Hediye */}
      {gifts.length > 0 && (
        <section>
          <h2>Congratulations! Your Gifts:</h2>
          <div style={{ fontSize: "2rem" }}>{gifts.join(" ")}</div>
        </section>
      )}

      <section>
        <p>Daily minutes: {dailyMinutes}</p>
        <p>Days completed: {progress.length} / 10</p>
      </section>
    </div>
  );
}

export default App;
