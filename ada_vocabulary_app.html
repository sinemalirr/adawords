<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ada Word World (Vocabulary App)</title>
    
    <!-- Tailwind CSS (Aesthetics & Responsiveness) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        :root {
            --primary: #FF6B6B; /* KÄ±rmÄ±zÄ±msÄ± Pembe */
            --secondary: #4ECDC4; /* Turkuaz */
            --accent: #FFE66D; /* SarÄ± */
            --dark: #2C3E50; /* Koyu Mavi */
        }
        
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }

        /* Mobil Cihaz GÃ¶rÃ¼nÃ¼mÃ¼ iÃ§in KÄ±sÄ±tlama */
        #app-container {
            max-width: 420px;
            height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* Flashcard Styling */
        .flashcard-container {
            perspective: 1000px;
            width: 90%;
            height: 250px;
        }
        .flashcard {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        .flashcard.flipped { transform: rotateY(180deg); }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--dark);
            border-radius: 15px;
            border: 3px solid var(--secondary);
            background-color: white;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
        }
        .card-back { transform: rotateY(180deg); background-color: #e0fffb; color: var(--primary); font-size: 1.5rem; }

        /* Button Animations */
        .btn-action {
            box-shadow: 0 4px 0 var(--dark);
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .btn-action:active {
            transform: translateY(2px);
            box-shadow: 2px 0 0 var(--dark);
        }
        
        /* Quiz Button Styling */
        .quiz-option-btn {
            box-shadow: 0 2px 0 #155e75; /* Teal shadow */
        }
        .quiz-option-btn:hover {
            background-color: #f0fdfa; /* Light teal on hover */
        }
        .quiz-option-btn:active {
            transform: translateY(1px);
            box-shadow: 0 1px 0 #155e75;
        }
    </style>
</head>
<body class="flex justify-center items-center h-screen">

<div id="app-container" class="bg-white flex flex-col">
    
    <!-- Header -->
    <header class="bg-gradient-to-br from-red-400 to-teal-400 text-white p-4 rounded-b-xl shadow-lg">
        <h1 class="text-2xl font-bold text-center">Ada Word World ğŸŒŸ</h1>
        <div class="flex justify-around items-center mt-2 text-sm font-semibold">
            <span>ğŸ”¥ Seri: <span id="streak-count">0</span> GÃ¼n</span>
            <span>â±ï¸ <span id="timer-display">00:00</span> / 15:00</span>
        </div>
        <p id="streak-goal-msg" class="text-center text-xs mt-1 italic opacity-90">10 days series get a gift!</p>
        <!-- Progress Bar -->
        <div class="w-full bg-white bg-opacity-30 rounded-full h-2 mt-2">
            <div id="progress-bar" class="bg-yellow-300 h-2 rounded-full transition-all duration-500" style="width: 0%;"></div>
        </div>
    </header>

    <!-- Main Content Area -->
    <div id="main-content" class="flex-1 p-5 overflow-y-auto">
        <div id="loading-screen" class="absolute inset-0 bg-white/80 flex items-center justify-center z-50">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-r-white border-teal-500 mx-auto"></div>
                <p class="mt-4 text-gray-700">BaÄŸlanÄ±lÄ±yor...</p>
            </div>
        </div>

        <!-- Screens will be rendered here -->
        <div id="screen-home" class="screen flex flex-col items-center space-y-5">
            <div class="text-center my-8">
                <h3 class="text-3xl font-extrabold text-gray-800">Welcome Ada!</h3>
                <p id="completion-msg" class="text-green-600 font-bold mt-2 hidden">Today is OK! âœ…</p>
                <p id="reward-notification" class="text-red-500 font-bold mt-2 text-lg animate-pulse hidden" onclick="showScreen('reward')">ğŸ Win the gift! TÄ±kla!</p>
            </div>
            
            <button class="w-11/12 p-4 bg-teal-500 text-white font-bold rounded-xl btn-action shadow-teal-700" onclick="startStudy('flashcard')">
                ğŸƒ CARDS
            </button>
            <button class="w-11/12 p-4 bg-red-500 text-white font-bold rounded-xl btn-action shadow-red-700" onclick="startStudy('quiz')">
                âœï¸ QUIZ
            </button>
            <button class="w-11/12 p-4 bg-yellow-500 text-white font-bold rounded-xl btn-action shadow-yellow-700" onclick="startStudy('fillInTheBlanks')">
                âœï¸ FILL THE BLANKS
            </button>
            <button class="w-11/12 p-4 bg-gray-600 text-white font-bold rounded-xl btn-action shadow-gray-800" onclick="showScreen('parent')">
                ğŸ”’ WORDS
            </button>
        </div>

        <!-- FLASHCARD EKRANI -->
        <div id="screen-flashcard" class="screen hidden flex-col items-center">
            <button class="text-gray-500 mb-4 self-start" onclick="stopStudy()">
                <span class="text-2xl">â¬…ï¸</span> Back to Menu
            </button>
            <div class="flashcard-container mb-6" onclick="flipCard()">
                <div class="flashcard" id="active-card">
                    <div class="card-face card-front border-teal-500">YÃ¼kleniyor...</div>
                    <div class="card-face card-back border-red-500">Loading...</div>
                </div>
            </div>
            <div class="flex space-x-4">
                <button class="p-3 bg-red-400 text-white font-semibold rounded-full btn-action shadow-red-600" onclick="nextCard(false)">
                    ğŸ˜“ Unuttum
                </button>
                <button class="p-3 bg-teal-500 text-white font-semibold rounded-full btn-action shadow-teal-700" onclick="nextCard(true)">
                    ğŸ§  Biliyorum
                </button>
            </div>
        </div>

        <!-- Ã‡OKTAN SEÃ‡MELÄ° EKRANI -->
        <div id="screen-quiz" class="screen hidden flex-col items-center">
            <button class="text-gray-500 mb-4 self-start" onclick="stopStudy()">
                <span class="text-2xl">â¬…ï¸</span> Back to Menu
            </button>
            
            <h3 class="text-xl font-semibold mb-6 text-gray-700">Choose the correct one:</h3>
            
            <p class="text-3xl font-bold text-red-500 mb-8 text-center px-4" id="quiz-question-mc">YÃ¼kleniyor...</p>

            <div id="answer-options-mc" class="flex flex-col space-y-4 w-full max-w-sm">
                <!-- Cevap butonlarÄ± buraya JS ile yÃ¼klenecek -->
            </div>
            
            <div id="quiz-feedback-mc" class="mt-6 h-6 font-bold text-center"></div>
        </div>

        <!-- BOÅLUK DOLDURMA EKRANI -->
        <div id="screen-fillInTheBlanks" class="screen hidden flex-col items-center">
            <button class="text-gray-500 mb-4 self-start" onclick="stopStudy()">
                <span class="text-2xl">â¬…ï¸</span> Back to Menu
            </button>
            
            <h3 class="text-xl font-semibold mb-6 text-gray-700">LÃ¼tfen doÄŸru Ã§eviriyi yazÄ±n:</h3>
            
            <p class="text-3xl font-bold text-red-500 mb-8 text-center px-4" id="fitb-question">YÃ¼kleniyor...</p>

            <input type="text" id="fitb-input" placeholder="CevabÄ±nÄ±zÄ± buraya yazÄ±n..." class="p-3 border-2 border-teal-500 rounded-lg w-full max-w-sm text-center text-xl focus:border-red-500 transition duration-300">
            
            <button class="w-full max-w-sm p-3 mt-4 bg-teal-500 text-white font-bold rounded-lg btn-action shadow-teal-700" onclick="checkFillInTheBlanksAnswer()">
                CevabÄ± Kontrol Et
            </button>
            
            <div id="fitb-feedback" class="mt-6 h-6 font-bold text-center"></div>
        </div>


        <!-- EBEVEYN EKRANI -->
        <div id="screen-parent" class="screen hidden flex-col items-center">
            <button class="text-gray-500 mb-6 self-start" onclick="showScreen('home')">
                <span class="text-2xl">â¬…ï¸</span> MenÃ¼ye DÃ¶n
            </button>
            <h3 class="text-2xl font-bold mb-4 text-gray-800">ğŸ”’ Kelime YÃ¶netimi (Ebeveyn)</h3>
            <p class="text-sm text-gray-500 mb-4">KullanÄ±cÄ± ID: <span class="font-mono text-xs text-red-500 break-all" id="user-id-display">YÃ¼kleniyor...</span></p>
            <div class="w-full max-w-sm bg-gray-100 p-4 rounded-xl space-y-3 shadow-inner">
                <input type="text" id="new-eng" placeholder="Ä°ngilizce Kelime" class="p-2 border rounded-lg w-full">
                <input type="text" id="new-tr" placeholder="TÃ¼rkÃ§e AnlamÄ±" class="p-2 border rounded-lg w-full">
                <button class="w-full p-2 bg-gray-600 text-white font-semibold rounded-lg btn-action shadow-gray-800" onclick="addWord()">
                    + Yeni Kelime Ekle
                </button>
            </div>

            <h4 class="text-xl font-semibold mt-6 mb-2">Ekli Kelimeler (<span id="word-count">0</span>)</h4>
            <div class="w-full max-w-sm h-48 overflow-y-auto border rounded-lg p-2 bg-white shadow-md">
                <ul id="word-list-display">
                    <!-- Kelimeler buraya gelecek -->
                </ul>
            </div>
            <p class="text-sm text-gray-500 mt-2">Bu ekranda harcanan sÃ¼re sayÄ±lmaz.</p>
        </div>

        <!-- Ã–DÃœL EKRANI -->
        <div id="screen-reward" class="screen hidden flex-col items-center justify-center h-full">
            <h2 class="text-3xl font-extrabold text-red-600 mb-4 animate-bounce">ğŸ‰ Congratilations ADA! ğŸ‰</h2>
            <p class="text-xl text-gray-700 mb-8">10 days serie is OK!</p>
            <p class="text-2xl font-semibold text-teal-600 mb-6">Choose yout gift:</p>
            <div class="flex space-x-6">
                <!-- Her kutuya specific Ã¶dÃ¼l atadÄ±k -->
                <div class="text-6xl cursor-pointer hover:scale-110 transition-transform gift-box" data-gift="1" onclick="openGift(1)">ğŸ</div>
                <div class="text-6xl cursor-pointer hover:scale-110 transition-transform gift-box" data-gift="2" onclick="openGift(2)">ğŸ</div>
                <div class="text-6xl cursor-pointer hover:scale-110 transition-transform gift-box" data-gift="3" onclick="openGift(3)">ğŸ</div>
            </div>
            <div id="gift-reveal" class="mt-8 p-4 bg-yellow-100 text-gray-900 rounded-lg shadow-inner text-center text-xl font-bold transition-all duration-500 opacity-0">
                <!-- Ã–dÃ¼l Buraya Gelecek -->
            </div>
            <button id="claim-button" class="mt-10 p-4 bg-teal-500 text-white font-bold rounded-xl btn-action shadow-teal-700 hidden" onclick="claimReward()">
                Take the gift, Back to Menu
            </button>
        </div>
    </div>
</div>

<!-- Custom Modal for Notifications (No alert()) -->
<div id="modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50">
    <div id="custom-modal" class="bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-sm text-center transform scale-90 transition-transform duration-300">
        <h3 id="modal-title" class="text-xl font-bold mb-3 text-red-500">Bildirim</h3>
        <p id="modal-message" class="text-gray-700 mb-5"></p>
        <button id="modal-ok-button" class="p-2 bg-teal-500 text-white rounded-lg w-full font-semibold" onclick="closeModal()">Tamam</button>
    </div>
</div>


<script type="module">
    // Firebase modÃ¼llerini iÃ§e aktarma
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, setPersistence, inMemoryPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, onSnapshot, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Hata ayÄ±klama iÃ§in log seviyesini ayarla
    setLogLevel('debug'); 

    // --- 1. FIREBASE KONFÄ°GÃœRASYONU VE BAÅLATMA ---
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    
    // Global deÄŸiÅŸkenler
    let app = null;
    let db = null;
    let auth = null;

    // --- TEMEL AYARLAR ---
    const TARGET_TIME = 15 * 60; // 15 dakika (saniye)
    const STREAK_GOAL = 10;
    const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-ada-voc-app-v1'; 

    let userId = null;
    let appData = null;
    let timerInterval = null;
    let isStudying = false;
    let words = []; // Kelime listesi
    let isAuthReady = false;

    // FITB iÃ§in deÄŸiÅŸkenler
    let currentStudyWord = null;
    let expectedAnswer = null; 

    // --- 2. FIREBASE VE AUTHENTICATION ---

    async function startApp() {
        document.getElementById('loading-screen').classList.remove('hidden');

        try {
            // Firestore baÅŸlatma
            if (!firebaseConfig || !firebaseConfig.projectId) {
                throw new Error("Firebase configuration is missing Project ID.");
            }
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            let userCredential = null;

            // Kimlik doÄŸrulama
            if (initialAuthToken) {
                // Custom Token ile giriÅŸ yap ve kalÄ±cÄ±lÄ±ÄŸÄ± memory'de tut
                await setPersistence(auth, inMemoryPersistence);
                userCredential = await signInWithCustomToken(auth, initialAuthToken);
            } else {
                // Anonim giriÅŸ yap
                userCredential = await signInAnonymously(auth);
            }

            // --- HATA Ã‡Ã–ZÃœMÃœ: userId'nin kesinlikle ayarlandÄ±ÄŸÄ±ndan emin ol ---
            if (userCredential && userCredential.user) {
                userId = userCredential.user.uid;
                isAuthReady = true;
                console.log("Firebase giriÅŸ baÅŸarÄ±lÄ±. User ID:", userId);
                
                // userId'yi hemen ekrana yazdÄ±r (Hata Ã§Ã¶zÃ¼mÃ¼ 1)
                document.getElementById('user-id-display').innerText = userId;

                // Veri dinleyicilerini baÅŸlat (Hata Ã§Ã¶zÃ¼mÃ¼ 2: Sadece auth baÅŸarÄ±lÄ±ysa Ã§aÄŸÄ±r)
                setupDataListeners();
            } else {
                 throw new Error("Firebase user ID could not be retrieved after sign-in.");
            }
            
        } catch (error) {
            console.error("Firebase baÅŸlatÄ±lÄ±rken veya baÄŸlanÄ±lÄ±rken hata:", error);
            showModal("BaÄŸlantÄ± HatasÄ±", `Uygulamaya baÄŸlanÄ±lamadÄ±. Hata: ${error.message}`);
        } finally {
            document.getElementById('loading-screen').classList.add('hidden');
        }
    }

    const getUserDataRef = () => doc(db, 'artifacts', APP_ID, 'users', userId, 'profile', 'meta');
    const getWordsRef = () => collection(db, 'artifacts', APP_ID, 'users', userId, 'words');

    async function setupDataListeners() {
        // Zaten startApp iÃ§inde userId ve isAuthReady kontrol edildi, ancak defensive programlama iÃ§in tutuyoruz.
        if (!isAuthReady || !db || !userId) return;

        // 1. Profil ve Seri Takibi Verilerini Dinleme
        onSnapshot(getUserDataRef(), (docSnapshot) => {
            if (docSnapshot.exists()) {
                appData = docSnapshot.data();
            } else {
                // EÄŸer veri yoksa, varsayÄ±lan deÄŸerleri oluÅŸtur ve kaydet
                appData = {
                    streak: 0,
                    todayTime: 0,
                    dayCompleted: false,
                    lastActiveDate: null,
                    lastCompletedDate: null,
                    rewardClaimed: true 
                };
                setDoc(getUserDataRef(), appData);
            }
            checkDayReset();
            updateUI();
        }, (error) => {
            console.error("User Data Snapshot Error:", error);
        });

        // 2. Kelimeleri Dinleme
        onSnapshot(getWordsRef(), (snapshot) => {
            words = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            updateWordListUI();
        }, (error) => {
            console.error("Words Snapshot Error:", error);
        });
    }

    function checkDayReset() {
        if (!appData) return;
        const todayStr = new Date().toDateString();
        
        if (appData.lastActiveDate !== todayStr) {
            
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toDateString();

            let newStreak = appData.streak;

            // EÄŸer bugÃ¼n aktif olunan ilk gÃ¼nse ve dÃ¼n tamamlanmadÄ±ysa, seriyi sÄ±fÄ±rla.
            if (appData.lastCompletedDate !== todayStr && appData.lastCompletedDate !== yesterdayStr) {
                newStreak = 0;
            }
            
            // VeritabanÄ±nÄ± gÃ¼ncelle
            updateDoc(getUserDataRef(), {
                todayTime: 0,
                dayCompleted: false,
                lastActiveDate: todayStr,
                streak: newStreak
            });
            
            appData.todayTime = 0;
            appData.dayCompleted = false;
            appData.lastActiveDate = todayStr;
            appData.streak = newStreak;
        }
    }

    // --- 3. AKILLI ZAMANLAYICI MANTIÄI ---

    function startTimer() {
        if (appData && appData.dayCompleted) {
            document.getElementById('completion-msg').classList.remove('hidden');
            return;
        }

        isStudying = true;
        
        if (timerInterval) clearInterval(timerInterval);
        
        timerInterval = setInterval(() => {
            if (!isStudying) return; 
            
            appData.todayTime++;
            updateUI();
            
            if (appData.todayTime >= TARGET_TIME && !appData.dayCompleted) {
                completeDay();
            }
        }, 1000);
    }

    function stopTimer() {
        isStudying = false;
        if (timerInterval) clearInterval(timerInterval);
        // Ã‡alÄ±ÅŸma sÃ¼resi durduÄŸunda, gÃ¼ncel sÃ¼reyi anÄ±nda kaydet
        if (appData && !appData.dayCompleted && appData.todayTime > 0) {
            updateDoc(getUserDataRef(), { todayTime: appData.todayTime });
        }
    }

    async function completeDay() {
        appData.dayCompleted = true;
        
        const lastCompletedDate = new Date().toDateString();
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toDateString();

        // Seri artÄ±ÅŸÄ± sadece art arda gÃ¼nlerde tamamlandÄ±ysa gerÃ§ekleÅŸir
        if (appData.lastCompletedDate === lastCompletedDate) {
            // Zaten bugÃ¼n tamamlanmÄ±ÅŸ, streak artmaz.
        } else if (appData.lastCompletedDate === yesterdayStr || appData.lastCompletedDate === null) {
            appData.streak++;
        }
        
        appData.lastCompletedDate = lastCompletedDate;
        
        showModal("Tebrikler!", "BugÃ¼nkÃ¼ 15 dakikalÄ±k hedefini tamamladÄ±n! Seriye 1 gÃ¼n eklendi.");
        
        await updateDoc(getUserDataRef(), {
            dayCompleted: true,
            streak: appData.streak,
            lastCompletedDate: appData.lastCompletedDate
        });
        
        checkRewardStatus();
        stopTimer();
    }

    // --- 4. Ã–DÃœL VE SERÄ° TAKÄ°BÄ° ---
    
    function checkRewardStatus() {
        if (!appData) return;
        
        const rewardNotif = document.getElementById('reward-notification');
        
        // Ã–dÃ¼l HakkÄ± Kazanma KontrolÃ¼
        if (appData.streak > 0 && appData.streak % STREAK_GOAL === 0 && appData.rewardClaimed === true) {
             // Sadece 10'un katlarÄ± ilk kez vurulduÄŸunda Ã¶dÃ¼l hakkÄ±nÄ± sÄ±fÄ±rla
             appData.rewardClaimed = false;
             updateDoc(getUserDataRef(), { rewardClaimed: false });
        }
        
        // Bildirim GÃ¶rÃ¼ntÃ¼leme KontrolÃ¼
        if (appData.rewardClaimed === false) {
            rewardNotif.classList.remove('hidden');
            rewardNotif.onclick = () => showScreen('reward');
        } else {
            rewardNotif.classList.add('hidden');
            rewardNotif.onclick = null;
        }
    }

    // KullanÄ±cÄ±nÄ±n istediÄŸi spesifik Ã¶dÃ¼l seÃ§enekleri
    const REWARD_OPTIONS = {
        1: "ğŸ” BÃ¼yÃ¼k Boy Hamburger MenÃ¼sÃ¼!",
        2: "ğŸ• Aile Boyu Pizza Ismarlama HakkÄ±!",
        3: "ğŸ’° 300 TL HarÃ§lÄ±k Kazanma HakkÄ±!",
        4: "ğŸ‰ SÃ¼rpriz Ã–dÃ¼l!" 
    };

    window.openGift = function(boxNum) {
        if (!appData || appData.rewardClaimed) {
            showModal("Hata", "Åu an aktif bir Ã¶dÃ¼l hakkÄ±n yok. Yeni seri iÃ§in Ã§alÄ±ÅŸmaya devam!");
            return;
        }
        
        const reveal = document.getElementById('gift-reveal');
        
        const rewardText = REWARD_OPTIONS[boxNum] || REWARD_OPTIONS[4]; 
        
        reveal.innerText = rewardText;
        reveal.classList.remove('opacity-0');
        reveal.classList.add('bg-yellow-300', 'shadow-2xl');
        
        document.querySelectorAll('.gift-box').forEach(box => {
            if (parseInt(box.dataset.gift) !== boxNum) {
                box.style.opacity = '0.3';
            } else {
                box.classList.remove('animate-bounce');
            }
            box.onclick = null; // TÃ¼m kutularÄ± tÄ±klanamaz yap
        });
        document.getElementById('claim-button').classList.remove('hidden');
    }

    window.claimReward = function() {
        if (appData && appData.rewardClaimed === false) {
             updateDoc(getUserDataRef(), { rewardClaimed: true });
        }
        document.getElementById('gift-reveal').classList.add('opacity-0');
        document.getElementById('claim-button').classList.add('hidden');
        
        // KutularÄ± tekrar tÄ±klanabilir yap
        document.querySelectorAll('.gift-box').forEach(box => {
            box.onclick = () => openGift(parseInt(box.dataset.gift));
            box.style.opacity = '1.0';
        });
        
        showScreen('home');
    }

    // --- 5. KELÄ°ME YÃ–NETÄ°MÄ° (EBEVEYN) ---

    window.addWord = async function() {
        const en = document.getElementById('new-eng').value.trim();
        const tr = document.getElementById('new-tr').value.trim();
        
        if (!en || !tr) {
            showModal("UyarÄ±", "LÃ¼tfen hem Ä°ngilizce kelimeyi hem de TÃ¼rkÃ§e anlamÄ±nÄ± girin.");
            return;
        }

        // Hata Ã§Ã¶zÃ¼mÃ¼: Firebase baÄŸlantÄ±sÄ± ve userId kontrolÃ¼
        if (!db || !userId) {
            showModal("Hata", "VeritabanÄ± baÄŸlantÄ±sÄ± henÃ¼z hazÄ±r deÄŸil. LÃ¼tfen bekleyin.");
            return;
        }

        try {
            // Kelime eklemek iÃ§in setDoc kullanÄ±yoruz, doc() ile otomatik ID oluÅŸturuluyor.
            await setDoc(doc(getWordsRef()), { 
                en: en, 
                tr: tr, 
                createdAt: new Date().toISOString() 
            });
            document.getElementById('new-eng').value = "";
            document.getElementById('new-tr').value = "";
            showModal("BaÅŸarÄ±lÄ±", `Kelime: "${en}" baÅŸarÄ±yla eklendi!`);
        } catch (error) {
            console.error("Kelime eklenirken hata:", error);
            showModal("Hata", "Kelime eklenirken bir sorun oluÅŸtu.");
        }
    }

    function updateWordListUI() {
        const list = document.getElementById('word-list-display');
        const count = document.getElementById('word-count');
        list.innerHTML = "";
        count.innerText = words.length;

        if (words.length === 0) {
            list.innerHTML = `<li class="p-2 text-center text-gray-400">HenÃ¼z kelime yok. LÃ¼tfen yukarÄ±dan ekleyin.</li>`;
            return;
        }

        words.forEach(w => {
            const li = document.createElement('li');
            li.className = 'flex justify-between items-center p-2 border-b last:border-b-0 text-gray-700 text-sm';
            li.innerHTML = `<span><strong class="text-teal-600">${w.en}</strong> - ${w.tr}</span>`;
            list.appendChild(li);
        });
    }
    
    // --- 6. Ã–ÄRENME MODÃœLLERÄ° VE YARDIMCI FONKSÄ°YONLAR ---
    
    function updateUI() {
        if (!appData) return;

        // ZamanlayÄ±cÄ±
        const minutes = Math.floor(appData.todayTime / 60).toString().padStart(2, '0');
        const seconds = (appData.todayTime % 60).toString().padStart(2, '0');
        document.getElementById('timer-display').innerText = `${minutes}:${seconds}`;

        // Ä°lerleme Ã‡ubuÄŸu
        const progress = Math.min(100, (appData.todayTime / TARGET_TIME) * 100);
        document.getElementById('progress-bar').style.width = `${progress}%`;
        
        // Seri ve Tamamlanma mesajÄ±
        document.getElementById('streak-count').innerText = appData.streak;
        document.getElementById('completion-msg').classList.toggle('hidden', !appData.dayCompleted);
        
        checkRewardStatus();
    }
    
    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.add('hidden');
            // Ekran deÄŸiÅŸtirirken tÃ¼m modÃ¼lleri durdur
            if (screen.id.includes('study')) {
                 screen.classList.remove('flex'); // Ã¶nceki ekranÄ± gizle
            }
        });

        const activeScreen = document.getElementById(`screen-${screenId}`);
        if (activeScreen) {
             activeScreen.classList.remove('hidden');
             activeScreen.classList.add('flex'); // Yeni ekranÄ± gÃ¶ster
        }

        // Parent ekranÄ±na girerken/Ã§Ä±karken zamanlayÄ±cÄ±yÄ± durdur
        if (screenId === 'home' && isStudying) {
            startTimer();
        } else if (screenId === 'parent') {
            stopTimer();
        }
    }
    window.showScreen = showScreen; // HTML'den eriÅŸim iÃ§in

    window.startStudy = function(mode) {
        if (words.length === 0) { 
            showModal("UyarÄ±", "LÃ¼tfen Ã¶nce kelime ekleyin.");
            return;
        }
        
        isStudying = true;
        startTimer();
        
        if (mode === 'flashcard') {
            showScreen('flashcard');
            loadFlashcard();
        } else if (mode === 'quiz') {
            if (words.length < 3) {
                showModal("UyarÄ±", "Ã‡oktan SeÃ§meli Quiz iÃ§in en az 3 kelime eklemelisin!");
                isStudying = false; stopTimer(); return;
            }
            showScreen('quiz');
            loadQuiz();
        } else if (mode === 'fillInTheBlanks') {
            showScreen('fillInTheBlanks');
            loadFillInTheBlanks();
        }
    }

    window.stopStudy = function() {
        isStudying = false;
        stopTimer();
        showScreen('home');
    }
    
    function showModal(title, message) {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-message').innerText = message;
        document.getElementById('modal-backdrop').classList.remove('hidden');
        document.getElementById('modal-backdrop').classList.add('flex');
        document.getElementById('custom-modal').classList.remove('scale-90');
        document.getElementById('custom-modal').classList.add('scale-100');
    }
    
    window.closeModal = function() {
        document.getElementById('custom-modal').classList.remove('scale-100');
        document.getElementById('custom-modal').classList.add('scale-90');
        setTimeout(() => {
            document.getElementById('modal-backdrop').classList.add('hidden');
            document.getElementById('modal-backdrop').classList.remove('flex');
        }, 300);
    }


    // FLASHCARD MANTIÄI
    function loadFlashcard() {
        // Kelimeleri karÄ±ÅŸtÄ±rarak seÃ§mek daha iyi bir Ã¶ÄŸrenme akÄ±ÅŸÄ± saÄŸlar
        const availableWords = [...words];
        if (availableWords.length === 0) return;

        currentStudyWord = availableWords[Math.floor(Math.random() * availableWords.length)];
        
        const card = document.getElementById('active-card');
        card.classList.remove('flipped');
        
        // KartÄ± Ã§evirmeden Ã¶nce metni yÃ¼klemek iÃ§in kÄ±sa bir gecikme
        setTimeout(() => {
            document.querySelector('#active-card .card-front').innerText = currentStudyWord.en;
            document.querySelector('#active-card .card-back').innerText = currentStudyWord.tr;
        }, 300);
    }

    window.flipCard = function() {
        document.getElementById('active-card').classList.toggle('flipped');
    }

    window.nextCard = function(known) {
        // known parametresi ile Ã¶ÄŸrenme seviyesi kaydedilebilir, ÅŸimdilik sadece bir sonraki karta geÃ§iliyor.
        loadFlashcard();
    }

    // QUIZ MANTIÄI (Ã‡oktan SeÃ§meli)
    
    /**
     * DoÄŸru kelime ve rastgele seÃ§ilmiÅŸ 2 yanlÄ±ÅŸ kelimeyi (Ã§eldiricileri) dÃ¶ndÃ¼rÃ¼r.
     */
    function getShuffledOptions(correctWord, allWords) {
        // DoÄŸru kelime dÄ±ÅŸÄ±ndaki tÃ¼m kelimeleri al
        const decoys = allWords.filter(w => w.en !== correctWord.en);
        
        // Rastgele 2 yanlÄ±ÅŸ kelime seÃ§
        const shuffledDecoys = decoys.sort(() => 0.5 - Math.random());
        // En az 2 Ã§eldirici olduÄŸundan emin olmak iÃ§in kontrol ediyoruz
        const incorrectOptions = shuffledDecoys.slice(0, Math.min(2, decoys.length)).map(w => ({ en: w.en, isCorrect: false }));
        
        // DoÄŸru kelimeyi ekle
        const correctOption = { en: correctWord.en, isCorrect: true };
        let options = [...incorrectOptions, correctOption];
        
        // SeÃ§enekleri karÄ±ÅŸtÄ±r
        return options.sort(() => 0.5 - Math.random());
    }

    window.loadQuiz = function() {
        // Kelime listesi yeterli deÄŸilse hata mesajÄ± gÃ¶ster (startStudy'de kontrol edildi, ama yine de gÃ¼venliÄŸe alalÄ±m)
        if (words.length < 3) {
            document.getElementById('quiz-question-mc').innerText = "Quiz iÃ§in en az 3 farklÄ± kelime ekleyin!";
            document.getElementById('answer-options-mc').innerHTML = "";
            return;
        }

        // Rastgele kelimeyi seÃ§
        currentStudyWord = words[Math.floor(Math.random() * words.length)];
        
        document.getElementById('quiz-question-mc').innerText = currentStudyWord.tr;
        const optionsContainer = document.getElementById('answer-options-mc');
        optionsContainer.innerHTML = "";
        document.getElementById('quiz-feedback-mc').innerText = "";

        const options = getShuffledOptions(currentStudyWord, words);
        
        options.forEach(option => {
            const button = document.createElement('button');
            button.className = 'w-full p-3 bg-white text-gray-800 font-semibold rounded-lg border-2 border-teal-500 hover:bg-teal-100 transition duration-150 shadow-md quiz-option-btn';
            button.innerText = option.en;
            button.dataset.isCorrect = option.isCorrect;
            button.onclick = () => checkAnswer(button);
            optionsContainer.appendChild(button);
        });
    }

    window.checkAnswer = function(selectedButton) {
        const optionsContainer = document.getElementById('answer-options-mc');
        const feedback = document.getElementById('quiz-feedback-mc');
        
        // TÃ¼m butonlarÄ± devre dÄ±ÅŸÄ± bÄ±rak
        Array.from(optionsContainer.children).forEach(btn => btn.onclick = null);

        if (selectedButton.dataset.isCorrect === 'true') {
            selectedButton.classList.remove('bg-white', 'border-teal-500', 'hover:bg-teal-100');
            selectedButton.classList.add('bg-green-500', 'text-white', 'border-green-700');
            feedback.innerText = "ğŸ‰ DoÄŸru Cevap!";
            feedback.className = "mt-6 h-6 font-bold text-green-600";
        } else {
            selectedButton.classList.remove('bg-white', 'border-teal-500', 'hover:bg-teal-100');
            selectedButton.classList.add('bg-red-500', 'text-white', 'border-red-700');
            feedback.innerText = "âŒ YanlÄ±ÅŸ Cevap.";
            feedback.className = "mt-6 h-6 font-bold text-red-600";
            
            // DoÄŸru cevabÄ± vurgula
            const correctButton = Array.from(optionsContainer.children).find(btn => btn.dataset.isCorrect === 'true');
            if (correctButton) {
                 correctButton.classList.remove('bg-white', 'border-teal-500', 'shadow-md', 'quiz-option-btn');
                 correctButton.classList.add('bg-green-200', 'border-green-500', 'text-gray-800', 'shadow-lg');
            }
        }
        
        // Yeni soruyu yÃ¼kle
        setTimeout(() => {
            loadQuiz();
        }, 1500); // 1.5 saniye sonra yeni soruya geÃ§
    }

    // QUIZ MANTIÄI (BoÅŸluk Doldurma)

    window.loadFillInTheBlanks = function() {
        if (words.length === 0) return;
        currentStudyWord = words[Math.floor(Math.random() * words.length)];
        
        // %50 ihtimalle EN->TR, %50 ihtimalle TR->EN
        const isEnToTr = Math.random() < 0.5; 
        
        const questionText = document.getElementById('fitb-question');
        const inputField = document.getElementById('fitb-input');
        const feedback = document.getElementById('fitb-feedback');
        const checkButton = document.querySelector('#screen-fillInTheBlanks button[onclick="checkFillInTheBlanksAnswer()"]');
        
        inputField.value = "";
        feedback.innerText = "";
        inputField.disabled = false;
        checkButton.disabled = false;
        
        inputField.classList.remove('bg-green-100', 'bg-red-100');
        
        if (isEnToTr) {
            questionText.innerText = `"${currentStudyWord.en}" kelimesinin TÃ¼rkÃ§e karÅŸÄ±lÄ±ÄŸÄ± nedir?`;
            expectedAnswer = currentStudyWord.tr;
            inputField.placeholder = "TÃ¼rkÃ§e AnlamÄ±...";
        } else {
            questionText.innerText = `"${currentStudyWord.tr}" kelimesinin Ä°ngilizce karÅŸÄ±lÄ±ÄŸÄ± nedir?`;
            expectedAnswer = currentStudyWord.en;
            inputField.placeholder = "English Word...";
        }
        
        inputField.focus();
    }

    window.checkFillInTheBlanksAnswer = function() {
        const userInput = document.getElementById('fitb-input').value.trim().toLowerCase();
        const feedback = document.getElementById('fitb-feedback');
        const inputField = document.getElementById('fitb-input');
        const checkButton = document.querySelector('#screen-fillInTheBlanks button[onclick="checkFillInTheBlanksAnswer()"]');
        
        const expected = expectedAnswer.toLowerCase();
        
        // CevabÄ±n birden fazla kelime olabileceÄŸi iÃ§in basit eÅŸitlik kontrolÃ¼
        const isCorrect = userInput === expected; 

        inputField.disabled = true; // CevaplandÄ±ktan sonra giriÅŸi kitle
        checkButton.disabled = true; // Butonu devre dÄ±ÅŸÄ± bÄ±rak

        if (isCorrect) {
            feedback.innerText = "ğŸ‰ DoÄŸru! SÃ¼per!";
            feedback.className = "mt-6 h-6 font-bold text-green-600";
            inputField.classList.add('bg-green-100');
        } else {
            feedback.innerHTML = `âŒ YanlÄ±ÅŸ. DoÄŸru cevap: <span class="text-teal-600 font-extrabold">${expectedAnswer}</span>`;
            feedback.className = "mt-6 h-6 font-bold text-red-600";
            inputField.classList.add('bg-red-100');
        }

        // Yeni soruyu yÃ¼kle
        setTimeout(() => {
            loadFillInTheBlanks();
        }, 2000); // 2 saniye sonra yeni soruya geÃ§
    }
    
    // --- UYGULAMAYI BAÅLAT ---
    startApp();

</script>
</body>
</html>
