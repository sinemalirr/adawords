<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGÄ°S - Tarihsel GeliÅŸim Takibi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; min-height: 100vh; }
        .tab-button { transition: all 0.1s; }
        .active-tab { 
            border-bottom: 3px solid #4f46e5; 
            color: #4f46e5; 
            font-weight: 600;
        }
        .analiz-card {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-top: 1rem;
        }
        .input-alan { width: 60px; text-align: center; }
        .tablo-satir th {
            font-weight: 600;
            color: #1f2937;
        }
        .table-scroll {
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
        .min-w-full thead th {
            position: sticky;
            top: 0;
            background-color: #f9fafb;
            z-index: 10;
        }
    </style>
</head>
<body>

<div class="w-full max-w-6xl mx-auto p-6 md:p-10 mt-8">

    <header class="pb-4 border-b border-gray-200 mb-6">
        <a href="dersler.html" class="text-indigo-600 hover:text-indigo-800 text-xl mb-4 inline-block">â† Ders SeÃ§imi</a>
        <h1 class="text-3xl font-extrabold text-gray-800 tracking-tight">ğŸ“ˆ AGÄ°S: Tarihsel GeliÅŸim Takibi</h1>
        <p class="text-sm text-gray-500 mt-2">GirdiÄŸiniz her deneme sonucu (manuel) kaydedilir ve geliÅŸim grafiÄŸi olarak gÃ¶sterilir.</p>
    </header>

    <div class="analiz-card mb-8 p-6 border-2 border-indigo-200">
        <h2 class="text-2xl font-bold text-indigo-700 mb-4">âœï¸ Yeni SonuÃ§ GiriÅŸi</h2>
        
        <div class="flex flex-col lg:flex-row lg:space-x-6 space-y-4 lg:space-y-0 mb-4 items-center">
             <div class="flex items-center space-x-2 w-full lg:w-1/3">
                <label for="test-adi-input" class="text-sm font-medium text-gray-700 whitespace-nowrap">Test AdÄ±:</label>
                <input type="text" id="test-adi-input" placeholder="Ã–rn: Deneme 1 / Hafta 3 SÃ¶zel" class="border rounded p-1.5 w-full">
            </div>
            
            <div class="flex items-center space-x-2 w-full lg:w-1/3">
                <label for="manuel-agis-puani-input" class="text-sm font-medium text-gray-700 whitespace-nowrap">AGÄ°S PuanÄ±:</label>
                <input type="number" id="manuel-agis-puani-input" value="0.00" min="0" max="500" step="0.01" class="border rounded p-1.5 w-24 text-lg font-bold text-indigo-700 text-center">
            </div>
        </div>

        <h3 class="text-lg font-semibold text-gray-800 mt-4 mb-2">SÃ¶zel (TÃ¼rkÃ§e:12, Sosyal:6, Din:6, Ä°ng:6)</h3>
        <div class="overflow-x-auto mb-4">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-700">Ders</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-green-600">D</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-red-600">Y</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500">B</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-indigo-600">Net</th>
                    </tr>
                </thead>
                <tbody id="input-sozel-tablosu" class="bg-white divide-y divide-gray-200">
                     </tbody>
            </table>
        </div>
        
        <h3 class="text-lg font-semibold text-gray-800 mt-4 mb-2">SayÄ±sal (Matematik:12, Fen:12)</h3>
         <div class="overflow-x-auto mb-4">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-700">Ders</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-green-600">D</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-red-600">Y</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500">B</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-indigo-600">Net</th>
                    </tr>
                </thead>
                <tbody id="input-sayisal-tablosu" class="bg-white divide-y divide-gray-200">
                     </tbody>
            </table>
        </div>
        
        <div class="flex justify-end mt-4">
             <button id="save-new-entry-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg transition duration-150">
                Yeni Sonucu Kaydet ve Analiz Et
            </button>
        </div>
        <p id="save-status" class="text-sm text-center mt-2 text-gray-500 hidden"></p>
    </div>

    <div class="border-b border-gray-200 mb-6">
        <nav class="flex space-x-4">
            <button id="tab-sozel" class="tab-button py-2 px-4 text-gray-500 hover:text-indigo-600 active-tab">
                SÃ¶zel Trend Analizi ğŸ“ˆ
            </button>
            <button id="tab-sayisal" class="tab-button py-2 px-4 text-gray-500 hover:text-indigo-600">
                SayÄ±sal Trend Analizi ğŸ“Š
            </button>
        </nav>
    </div>

    <main id="content-sozel" class="space-y-8">
        <h2 class="text-2xl font-bold text-gray-700">SÃ¶zel Toplam Net GeliÅŸim GrafiÄŸi (Tarihsel)</h2>
        <div class="analiz-card">
            <canvas id="sozelGrafikDetay"></canvas>
        </div>

        <h2 class="text-2xl font-bold text-gray-700 pt-6 border-t border-gray-200">SÃ¶zel Net DetaylÄ± KayÄ±t Tablosu</h2>
        <div class="analiz-card table-scroll">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tarih / Deneme</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TÃ¼rkÃ§e Net</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sosyal Net</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Din Net</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ä°ngilizce Net</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-indigo-600 uppercase tracking-wider">Toplam SÃ¶zel Net</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-purple-600 uppercase tracking-wider">Manuel AGÄ°S PuanÄ±</th>
                    </tr>
                </thead>
                <tbody id="sozel-sonuc-tablosu" class="bg-white divide-y divide-gray-200">
                    </tbody>
            </table>
            <p id="sozel-uyari" class="p-4 text-center text-gray-500 hidden">HenÃ¼z kayÄ±tlÄ± sonuÃ§ bulunmamaktadÄ±r.</p>
        </div>
    </main>
    
    <main id="content-sayisal" class="hidden space-y-8">
        <h2 class="text-2xl font-bold text-gray-700">SayÄ±sal Toplam Net GeliÅŸim GrafiÄŸi (Tarihsel)</h2>
        <div class="analiz-card">
            <canvas id="sayisalGrafikDetay"></canvas>
        </div>
        
        <h2 class="text-2xl font-bold text-gray-700 pt-6 border-t border-gray-200">SayÄ±sal Net DetaylÄ± KayÄ±t Tablosu</h2>
        <div class="analiz-card table-scroll">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tarih / Deneme</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Matematik Net</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fen Net</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-indigo-600 uppercase tracking-wider">Toplam SayÄ±sal Net</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-purple-600 uppercase tracking-wider">Manuel AGÄ°S PuanÄ±</th>
                    </tr>
                </thead>
                <tbody id="sayisal-sonuc-tablosu" class="bg-white divide-y divide-gray-200">
                    </tbody>
            </table>
            <p id="sayisal-uyari" class="p-4 text-center text-gray-500 hidden">HenÃ¼z kayÄ±tlÄ± sonuÃ§ bulunmamaktadÄ±r.</p>
        </div>
    </main>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="js/firebase-init.js"></script> 

<script>
    let sozelChartInstance = null;
    let sayisalChartInstance = null;
    let authUser = null;
    let historicalData = []; // TÃ¼m geÃ§miÅŸ verileri tutan dizi

    // LGS Soru DaÄŸÄ±lÄ±mÄ± (GÃœNCELLENMÄ°Å)
    const subjectDetails = {
        'turkce': { max: 12, net: 0, label: 'TÃ¼rkÃ§e', category: 'sozel' },
        'sosyal': { max: 6, net: 0, label: 'Sosyal', category: 'sozel' },
        'din': { max: 6, net: 0, label: 'Din K.', category: 'sozel' },
        'ingilizce': { max: 6, net: 0, label: 'Ä°ngilizce', category: 'sozel' },
        'matematik': { max: 12, net: 0, label: 'Matematik', category: 'sayisal' },
        'fen': { max: 12, net: 0, label: 'Fen Bil.', category: 'sayisal' }
    };

    const sozelSubjects = ['turkce', 'sosyal', 'din', 'ingilizce'];
    const sayisalSubjects = ['matematik', 'fen'];
    const AGIS_COLLECTION = 'agisUserEntries'; // Tarihsel kayÄ±tlar iÃ§in yeni koleksiyon

    // --------------------------------------------------------------------------------
    // 1. INPUT ALANLARININ OLUÅTURULMASI VE KONTROLÃœ
    // --------------------------------------------------------------------------------

    // GiriÅŸ formlarÄ±nÄ± dinamik olarak oluÅŸtur
    function createInputRows() {
        const sozelTable = document.getElementById('input-sozel-tablosu');
        const sayisalTable = document.getElementById('input-sayisal-tablosu');
        sozelTable.innerHTML = '';
        sayisalTable.innerHTML = '';

        [...sozelSubjects, ...sayisalSubjects].forEach(subject => {
            const detail = subjectDetails[subject];
            const tableBody = detail.category === 'sozel' ? sozelTable : sayisalTable;
            
            const row = tableBody.insertRow();
            row.id = `input-row-${subject}`;

            row.innerHTML = `
                <th class="px-3 py-2 text-left text-sm whitespace-nowrap">${detail.label}</th>
                <td class="px-3 py-2 text-center"><input type="number" id="${subject}-d-input" value="0" min="0" max="${detail.max}" class="input-alan border rounded" onchange="validateAndCalculate('${subject}')"></td>
                <td class="px-3 py-2 text-center"><input type="number" id="${subject}-y-input" value="0" min="0" max="${detail.max}" class="input-alan border rounded" onchange="validateAndCalculate('${subject}')"></td>
                <td class="px-3 py-2 text-center"><input type="number" id="${subject}-b-input" value="0" min="0" max="${detail.max}" class="input-alan border rounded" onchange="validateAndCalculate('${subject}')"></td>
                <td id="${subject}-net-display" class="px-3 py-2 text-center text-sm font-bold text-indigo-600">0.00</td>
            `;
        });
    }

    // Girdi kontrolÃ¼ ve anlÄ±k net hesaplama
    window.validateAndCalculate = function(subject) {
        const dInput = document.getElementById(`${subject}-d-input`);
        const yInput = document.getElementById(`${subject}-y-input`);
        const bInput = document.getElementById(`${subject}-b-input`);
        const maxQuestions = subjectDetails[subject].max;

        let d = parseInt(dInput.value) || 0;
        let y = parseInt(yInput.value) || 0;
        let b = parseInt(bInput.value) || 0;

        // Negatif deÄŸer kontrolÃ¼
        d = Math.max(0, d); dInput.value = d;
        y = Math.max(0, y); yInput.value = y;
        b = Math.max(0, b); bInput.value = b;

        let total = d + y + b;
        
        // Toplam soru kontrolÃ¼ (Hata durumunda BoÅŸ'tan dÃ¼ÅŸme)
        if (total > maxQuestions) {
            const excess = total - maxQuestions;
            // alert(`Hata: ${subjectDetails[subject].label} dersinde toplam giriÅŸ (${total}) ${maxQuestions}'Ã¼ aÅŸÄ±yor. BoÅŸ hanesi otomatik dÃ¼zeltildi.`);
            
            // FazlalÄ±ÄŸÄ± BoÅŸ hanesinden Ã§Ä±kar
            if (b >= excess) {
                 b -= excess;
                 bInput.value = b;
            } else if (y >= excess) {
                 // EÄŸer boÅŸ yetmezse, yanlÄ±ÅŸ hanesinden Ã§Ä±kar (Bu, deneme anÄ±nda deÄŸil, veri giriÅŸinde olduÄŸu iÃ§in kabul edilebilir)
                 y -= excess;
                 yInput.value = y;
            } else {
                 d -= excess;
                 dInput.value = d;
            }
            // Yeni total hesaplanÄ±r
            total = d + y + b;
        }
        
        // AnlÄ±k net hesaplama ve gÃ¶rÃ¼ntÃ¼leme
        let net = d - (y / 3);
        net = Math.max(0, net);
        net = Math.min(maxQuestions, net);
        document.getElementById(`${subject}-net-display`).textContent = net.toFixed(2);
    }
    
    // --------------------------------------------------------------------------------
    // 2. VERÄ° KAYDETME VE YÃœKLEME (FIREBASE)
    // --------------------------------------------------------------------------------

    // Yeni deneme sonucunu kaydet
    function saveNewAgisEntry() {
        if (!authUser || typeof db === 'undefined') {
             document.getElementById('save-status').textContent = 'HATA: GiriÅŸ yapmadÄ±nÄ±z. Veri kaydedilemedi.';
             document.getElementById('save-status').classList.remove('hidden');
             return;
        }

        const testName = document.getElementById('test-adi-input').value.trim();
        const manuelAgisPuanÄ± = parseFloat(document.getElementById('manuel-agis-puani-input').value) || 0.00;

        if (testName === '') {
             document.getElementById('save-status').textContent = 'HATA: LÃ¼tfen Deneme AdÄ±nÄ± giriniz.';
             document.getElementById('save-status').classList.remove('hidden');
             return;
        }

        let totalNet = 0;
        const scores = {};
        
        // TÃ¼m derslerin skorlarÄ±nÄ± topla ve kaydet
        [...sozelSubjects, ...sayisalSubjects].forEach(subject => {
            const d = parseInt(document.getElementById(`${subject}-d-input`).value) || 0;
            const y = parseInt(document.getElementById(`${subject}-y-input`).value) || 0;
            const b = parseInt(document.getElementById(`${subject}-b-input`).value) || 0;

            const net = Math.max(0, d - (y / 3));
            totalNet += net;

            scores[subject] = { d, y, b, net: parseFloat(net.toFixed(2)) };
        });

        const entryData = {
            userId: authUser.uid,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            testName: testName,
            manuelAgisPuanÄ±: parseFloat(manuelAgisPuanÄ±.toFixed(2)),
            totalNet: parseFloat(totalNet.toFixed(2)),
            scores: scores
        };
        
        db.collection(AGIS_COLLECTION).add(entryData)
        .then(() => {
            document.getElementById('save-status').textContent = `BAÅARILI: "${testName}" kaydÄ± yapÄ±ldÄ±. Grafik gÃ¼ncelleniyor.`;
            document.getElementById('save-status').classList.remove('hidden');
            document.getElementById('save-status').classList.remove('text-red-500');
            document.getElementById('save-status').classList.add('text-green-600');
            
            // KayÄ±ttan sonra veriyi tekrar yÃ¼kle ve grafikleri gÃ¼ncelle
            loadHistoricalAgisData(); 
            
            // Formu sÄ±fÄ±rla
            resetInputForm(); 
        })
        .catch((error) => {
            document.getElementById('save-status').textContent = `HATA: KayÄ±t sÄ±rasÄ±nda sorun oluÅŸtu: ${error.message}`;
            document.getElementById('save-status').classList.remove('hidden');
            document.getElementById('save-status').classList.add('text-red-500');
            console.error("Yeni AGIS verisi kaydedilirken hata:", error);
        });
    }

    // Tarihsel verileri Ã§ek ve tablolarÄ±/grafikleri render et
    function loadHistoricalAgisData() {
        if (!authUser || typeof db === 'undefined') return;

        db.collection(AGIS_COLLECTION)
            .where('userId', '==', authUser.uid)
            .orderBy('timestamp', 'asc') // Kronolojik sÄ±ralama
            .get()
            .then(snapshot => {
                historicalData = [];
                snapshot.forEach(doc => {
                    historicalData.push(doc.data());
                });

                // TablolarÄ± ve Grafikleri Doldur
                renderHistoricalTable(historicalData, 'sozel');
                renderHistoricalTable(historicalData, 'sayisal');
                renderTrendChart(historicalData, 'sozel');
                renderTrendChart(historicalData, 'sayisal');
            })
            .catch(error => {
                console.error("Tarihsel AGIS verileri yÃ¼klenirken hata:", error);
                document.getElementById('sozel-uyari').textContent = 'Veri yÃ¼klenirken bir hata oluÅŸtu.';
                document.getElementById('sozel-uyari').classList.remove('hidden');
            });
    }

    // --------------------------------------------------------------------------------
    // 3. TARÄ°HSEL TABLO VE GRAFÄ°K RENDER Ä°ÅLEVLERÄ°
    // --------------------------------------------------------------------------------

    function renderHistoricalTable(data, category) {
        const tableBody = document.getElementById(`${category}-sonuc-tablosu`);
        const uyari = document.getElementById(`${category}-uyari`);
        tableBody.innerHTML = '';

        if (data.length === 0) {
            uyari.classList.remove('hidden');
            return;
        }

        uyari.classList.add('hidden');

        // Ters kronolojik sÄ±ra (en yeni en Ã¼stte) iÃ§in veriyi ters Ã§evir
        const reversedData = [...data].reverse();

        reversedData.forEach(r => {
            const row = tableBody.insertRow();
            
            const date = r.timestamp ? r.timestamp.toDate().toLocaleDateString('tr-TR', { year: 'numeric', month: 'short', day: 'numeric' }) : 'Tarih Yok';
            
            // SÃ¶zel Tablo Ä°Ã§eriÄŸi
            if (category === 'sozel') {
                const totalSozelNet = (r.scores.turkce.net + r.scores.sosyal.net + r.scores.din.net + r.scores.ingilizce.net).toFixed(2);
                row.innerHTML = `
                    <td class="px-3 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">${date} - ${r.testName}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-green-600">${r.scores.turkce.net.toFixed(2)}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-green-600">${r.scores.sosyal.net.toFixed(2)}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-green-600">${r.scores.din.net.toFixed(2)}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-green-600">${r.scores.ingilizce.net.toFixed(2)}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm font-extrabold text-indigo-600">${totalSozelNet}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm font-extrabold text-purple-600">${r.manuelAgisPuanÄ±.toFixed(2)}</td>
                `;
            } 
            // SayÄ±sal Tablo Ä°Ã§eriÄŸi (YENÄ° EKLENEN KISIM)
            else if (category === 'sayisal') {
                const totalSayisalNet = (r.scores.matematik.net + r.scores.fen.net).toFixed(2);
                row.innerHTML = `
                    <td class="px-3 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">${date} - ${r.testName}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-green-600">${r.scores.matematik.net.toFixed(2)}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-green-600">${r.scores.fen.net.toFixed(2)}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm font-extrabold text-indigo-600">${totalSayisalNet}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm font-extrabold text-purple-600">${r.manuelAgisPuanÄ±.toFixed(2)}</td>
                `;
            }
        });
    }

    function renderTrendChart(data, category) {
        const chartId = category === 'sozel' ? 'sozelGrafikDetay' : 'sayisalGrafikDetay';
        let chartInstance = category === 'sozel' ? sozelChartInstance : sayisalChartInstance;
        
        if (chartInstance) {
            chartInstance.destroy();
        }
        
        const ctx = document.getElementById(chartId).getContext('2d');
        
        // Grafik verilerini hazÄ±rla (X ekseni: Deneme AdÄ±, Y ekseni: Net ve AGÄ°S PuanÄ±)
        const labels = data.map(r => r.testName);
        const agisPuanlari = data.map(r => r.manuelAgisPuanÄ±);
        
        let totalNets = [];
        if (category === 'sozel') {
            totalNets = data.map(r => r.scores.turkce.net + r.scores.sosyal.net + r.scores.din.net + r.scores.ingilizce.net);
        } else {
            totalNets = data.map(r => r.scores.matematik.net + r.scores.fen.net);
        }
        
        const titleText = category === 'sozel' ? 'SÃ¶zel Net ve Puan GeliÅŸimi' : 'SayÄ±sal Net ve Puan GeliÅŸimi';

        chartInstance = new Chart(ctx, {
            type: 'line', 
            data: {
                labels: labels,
                datasets: [
                {
                    label: `Toplam ${category === 'sozel' ? 'SÃ¶zel' : 'SayÄ±sal'} Net`,
                    data: totalNets,
                    borderColor: '#4f46e5', // Indigo
                    backgroundColor: 'rgba(79, 70, 229, 0.2)',
                    fill: true,
                    yAxisID: 'y'
                },
                {
                    label: 'Manuel AGÄ°S PuanÄ±',
                    data: agisPuanlari,
                    borderColor: '#9333ea', // Purple
                    backgroundColor: '#9333ea',
                    type: 'line',
                    fill: false,
                    yAxisID: 'y1' 
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'top' },
                    title: {
                        display: true,
                        text: titleText
                    }
                },
                scales: {
                    x: {
                        ticks: { maxRotation: 45, minRotation: 45 }
                    },
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Toplam Net (Hesaplanan)' },
                        position: 'left',
                        suggestedMax: category === 'sozel' ? 30 : 25
                    },
                    y1: { 
                        type: 'linear',
                        display: true,
                        position: 'right', 
                        grid: { drawOnChartArea: false },
                        title: { display: true, text: 'AGÄ°S PuanÄ± (Manuel)' },
                        suggestedMax: 500
                    }
                }
            }
        });

        if (category === 'sozel') {
            sozelChartInstance = chartInstance;
        } else {
            sayisalChartInstance = chartInstance;
        }
    }

    // --------------------------------------------------------------------------------
    // 4. DÄ°ÄER Ä°ÅLEVLER VE BAÄLANTILAR
    // --------------------------------------------------------------------------------
    
    // Yeni kayÄ±t formunu sÄ±fÄ±rla
    function resetInputForm() {
         document.getElementById('test-adi-input').value = '';
         document.getElementById('manuel-agis-puani-input').value = 0.00;
         // Input deÄŸerlerini sÄ±fÄ±rla ve netleri yeniden hesapla
         [...sozelSubjects, ...sayisalSubjects].forEach(subject => {
             document.getElementById(`${subject}-d-input`).value = 0;
             document.getElementById(`${subject}-y-input`).value = 0;
             document.getElementById(`${subject}-b-input`).value = 0;
             document.getElementById(`${subject}-net-display`).textContent = '0.00';
         });
    }

    function switchTab(target) {
        const sozelContent = document.getElementById('content-sozel');
        const sayisalContent = document.getElementById('content-sayisal');
        const sozelTab = document.getElementById('tab-sozel');
        const sayisalTab = document.getElementById('tab-sayisal');

        if (target === 'sozel') {
            sozelContent.classList.remove('hidden');
            sayisalContent.classList.add('hidden');
            sozelTab.classList.add('active-tab');
            sayisalTab.classList.remove('active-tab');
        } else {
            sozelContent.classList.add('hidden');
            sayisalContent.classList.remove('hidden');
            sayisalTab.classList.add('active-tab');
            sozelTab.classList.remove('active-tab');
        }
    }
    
    function attachEventListeners() {
        document.getElementById('save-new-entry-btn').addEventListener('click', saveNewAgisEntry);
        document.getElementById('tab-sozel').addEventListener('click', () => switchTab('sozel'));
        document.getElementById('tab-sayisal').addEventListener('click', () => switchTab('sayisal'));

        // AnlÄ±k AGIS puanÄ±nÄ± anlÄ±k yansÄ±tma (input change ile)
        document.getElementById('manuel-agis-puani-input').addEventListener('change', () => {
             // Sadece SayÄ±sal sekmesi altÄ±ndaki baÅŸlÄ±ÄŸÄ± gÃ¼ncelliyoruz
             const agisDisplay = document.querySelector('#content-sayisal #gosterilen-agis-puani');
             if (agisDisplay) {
                 agisDisplay.textContent = (parseFloat(document.getElementById('manuel-agis-puani-input').value) || 0.00).toFixed(2);
             }
        });
    }

    // Sayfa yÃ¼klendiÄŸinde Firebase baÄŸlantÄ±sÄ±nÄ± kur ve verileri yÃ¼kle
    document.addEventListener('DOMContentLoaded', () => {
        createInputRows(); // Input formlarÄ±nÄ± oluÅŸtur
        attachEventListeners(); // Olay dinleyicilerini baÄŸla

        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                authUser = user;
                loadHistoricalAgisData(); // GiriÅŸ yapÄ±ldÄ±ysa verileri yÃ¼kle
            } else {
                // GiriÅŸ yapÄ±lmadÄ±ysa uyarÄ± ver
                document.getElementById('save-status').textContent = "UyarÄ±: GiriÅŸ yapmadÄ±ÄŸÄ±nÄ±z iÃ§in sonuÃ§larÄ±nÄ±z kaydedilmeyecektir.";
                document.getElementById('save-status').classList.remove('hidden');
                document.getElementById('save-status').classList.add('text-red-500');
            }
        });
    });
</script>

</body>
</html>
